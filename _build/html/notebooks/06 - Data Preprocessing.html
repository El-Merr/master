
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecture 6. Data preprocessing &#8212; ML Engineering</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/banner.jpeg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">ML Engineering</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Overview
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01%20-%20Introduction.html">
   Lecture 1: Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02%20-%20Linear%20Models.html">
   Lecture 2: Linear models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03%20-%20Kernelization.html">
   Lecture 3: Kernelization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04%20-%20Model%20Selection.html">
   Lecture 4: Model Selection
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/06 - Data Preprocessing.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ml-course/master"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ml-course/master/issues/new?title=Issue%20on%20page%20%2Fnotebooks/06 - Data Preprocessing.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ml-course/master/master?urlpath=tree/notebooks/06 - Data Preprocessing.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/ml-course/master/blob/master/notebooks/06 - Data Preprocessing.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Lecture 6. Data preprocessing
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-transformations">
   Data transformations
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scaling">
   Scaling
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-do-we-need-scaling">
     Why do we need scaling?
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standard-scaling-standardization">
     Standard scaling (standardization)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#min-max-scaling">
     Min-max scaling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#robust-scaling">
     Robust scaling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#normalization">
     Normalization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#maximum-absolute-scaler">
     Maximum Absolute scaler
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#power-transformations">
     Power transformations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#categorical-feature-encoding">
   Categorical feature encoding
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ordinal-encoding">
     Ordinal encoding
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-hot-encoding-dummy-encoding">
     One-hot encoding (dummy encoding)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#target-encoding">
     Target encoding
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example">
       Example:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-scikit-learn">
     In practice (scikit-learn)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#applying-data-transformations">
   Applying data transformations
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     In practice (scikit-learn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-set-distortion-example">
     Test set distortion example
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-leakage-example">
     Data leakage example
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pipelines">
   Pipelines
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     In practice (scikit-learn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-scikit-learn-continued">
     In practice (scikit-learn), continued
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     In practice (scikit-learn), continued
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-selection-scikit-learn">
     Model selection (scikit-learn)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-tune-multiple-steps-at-once">
       Example: Tune multiple steps at once
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#automatic-feature-selection">
   Automatic Feature Selection
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-bike-sharing">
     Example: bike sharing
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unsupervised-feature-selection">
     Unsupervised feature selection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#covariance-based-feature-selection">
       Covariance based feature selection
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supervised-feature-selection-overview">
     Supervised feature selection: overview
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#univariate-statistics-f-test">
     Univariate statistics (F-test)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#f-statistic">
       F-statistic
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mutual-information">
     Mutual information
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-feature-selection">
     Model-based Feature Selection
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#relief-model-based-selection-with-knn">
     Relief: Model-based selection with kNN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-feature-selection-iterative">
     Model-based Feature Selection (iterative)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sequential-feature-selection-wrapping">
     Sequential feature selection (Wrapping)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#permutation-feature-importance">
     Permutation feature importance
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparison">
     Comparison
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       In practice (scikit-learn)
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       In practice (scikit-learn)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-engineering">
   Feature Engineering
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polynomials">
     Polynomials
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#binning">
     Binning
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#binning-interaction-features">
     Binning + interaction features
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-feature-interactions">
     Categorical feature interactions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#missing-value-imputation">
   Missing value imputation
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview">
     Overview
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mean-imputation">
     Mean imputation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#knn-imputation">
     kNN imputation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#iterative-model-based-imputation">
     Iterative (model-based) Imputation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization">
     Matrix Factorization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#soft-thresholded-singular-value-decomposition-svd">
     Soft-thresholded Singular Value Decomposition (SVD)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Comparison
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     In practice (scikit-learn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-fancyimpute">
     In practice (fancyimpute)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#handling-imbalanced-data">
   Handling imbalanced data
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-undersampling">
     Random Undersampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-undersampling">
     Model-based Undersampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-oversampling">
     Random Oversampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#synthetic-minority-oversampling-technique-smote">
     Synthetic Minority Oversampling Technique (SMOTE)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combined-techniques">
     Combined techniques
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ensemble-resampling">
     Ensemble Resampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Comparison
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-imblearn">
     In practice (imblearn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#real-world-data">
     Real-world data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Lecture 6. Data preprocessing</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Lecture 6. Data preprocessing
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-transformations">
   Data transformations
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#scaling">
   Scaling
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-do-we-need-scaling">
     Why do we need scaling?
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#standard-scaling-standardization">
     Standard scaling (standardization)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#min-max-scaling">
     Min-max scaling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#robust-scaling">
     Robust scaling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#normalization">
     Normalization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#maximum-absolute-scaler">
     Maximum Absolute scaler
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#power-transformations">
     Power transformations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#categorical-feature-encoding">
   Categorical feature encoding
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ordinal-encoding">
     Ordinal encoding
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-hot-encoding-dummy-encoding">
     One-hot encoding (dummy encoding)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#target-encoding">
     Target encoding
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example">
       Example:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-scikit-learn">
     In practice (scikit-learn)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#applying-data-transformations">
   Applying data transformations
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     In practice (scikit-learn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-set-distortion-example">
     Test set distortion example
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-leakage-example">
     Data leakage example
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pipelines">
   Pipelines
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     In practice (scikit-learn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-scikit-learn-continued">
     In practice (scikit-learn), continued
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     In practice (scikit-learn), continued
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-selection-scikit-learn">
     Model selection (scikit-learn)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-tune-multiple-steps-at-once">
       Example: Tune multiple steps at once
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#automatic-feature-selection">
   Automatic Feature Selection
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-bike-sharing">
     Example: bike sharing
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unsupervised-feature-selection">
     Unsupervised feature selection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#covariance-based-feature-selection">
       Covariance based feature selection
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supervised-feature-selection-overview">
     Supervised feature selection: overview
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#univariate-statistics-f-test">
     Univariate statistics (F-test)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#f-statistic">
       F-statistic
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mutual-information">
     Mutual information
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-feature-selection">
     Model-based Feature Selection
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#relief-model-based-selection-with-knn">
     Relief: Model-based selection with kNN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-feature-selection-iterative">
     Model-based Feature Selection (iterative)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sequential-feature-selection-wrapping">
     Sequential feature selection (Wrapping)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#permutation-feature-importance">
     Permutation feature importance
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparison">
     Comparison
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       In practice (scikit-learn)
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       In practice (scikit-learn)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-engineering">
   Feature Engineering
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#polynomials">
     Polynomials
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#binning">
     Binning
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#binning-interaction-features">
     Binning + interaction features
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-feature-interactions">
     Categorical feature interactions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#missing-value-imputation">
   Missing value imputation
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview">
     Overview
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mean-imputation">
     Mean imputation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#knn-imputation">
     kNN imputation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#iterative-model-based-imputation">
     Iterative (model-based) Imputation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization">
     Matrix Factorization
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#soft-thresholded-singular-value-decomposition-svd">
     Soft-thresholded Singular Value Decomposition (SVD)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Comparison
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     In practice (scikit-learn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-fancyimpute">
     In practice (fancyimpute)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#handling-imbalanced-data">
   Handling imbalanced data
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-undersampling">
     Random Undersampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-based-undersampling">
     Model-based Undersampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-oversampling">
     Random Oversampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#synthetic-minority-oversampling-technique-smote">
     Synthetic Minority Oversampling Technique (SMOTE)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#combined-techniques">
     Combined techniques
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ensemble-resampling">
     Ensemble Resampling
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Comparison
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#in-practice-imblearn">
     In practice (imblearn)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#real-world-data">
     Real-world data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Global imports and settings</span>
<span class="kn">from</span> <span class="nn">preamble</span> <span class="kn">import</span> <span class="o">*</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1">#InteractiveShell.ast_node_interactivity = &quot;all&quot;</span>
<span class="n">HTML</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;&lt;style&gt;html, body{overflow-y: visible !important} .CodeMirror{min-width:105% !important;} .rise-enabled .CodeMirror, .rise-enabled .output_subarea{font-size:140%; line-height:1.2; overflow: visible;} .output_subarea pre</span><span class="si">{width:110%}</span><span class="s1">&lt;/style&gt;&#39;&#39;&#39;</span><span class="p">)</span> <span class="c1"># For slides</span>
<span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Set to True for interactive plots </span>
<span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">table_font_size</span> <span class="o">=</span> <span class="s1">&#39;30px&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">table_font_size</span> <span class="o">=</span> <span class="s1">&#39;20px&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="lecture-6-data-preprocessing">
<h1>Lecture 6. Data preprocessing<a class="headerlink" href="#lecture-6-data-preprocessing" title="Permalink to this headline">¶</a></h1>
<p><strong>Real-world machine learning pipelines</strong></p>
<p>Joaquin Vanschoren</p>
</div>
<div class="section" id="data-transformations">
<h1>Data transformations<a class="headerlink" href="#data-transformations" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Machine learning models make a lot of assumptions about the data</p></li>
<li><p>In reality, these assumptions are often violated</p></li>
<li><p>We build <em>pipelines</em> that <em>transform</em> the data before feeding it to the learners</p>
<ul>
<li><p>Scaling (or other numeric transformations)</p></li>
<li><p>Encoding (convert categorical features into numerical ones)</p></li>
<li><p>Automatic feature selection</p></li>
<li><p>Feature engineering (e.g. binning, polynomial features,…)</p></li>
<li><p>Handling missing data</p></li>
<li><p>Handling imbalanced data</p></li>
<li><p>Dimensionality reduction (e.g. PCA)</p></li>
<li><p>Learned embeddings (e.g. for text)</p></li>
</ul>
</li>
<li><p>Seek the best combinations of transformations and learning methods</p>
<ul>
<li><p>Often done empirically, using cross-validation</p></li>
<li><p>Make sure that there is no data leakage during this process!</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="scaling">
<h1>Scaling<a class="headerlink" href="#scaling" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Use when different numeric features have different scales (different range of values)</p>
<ul>
<li><p>Features with much higher values may overpower the others</p></li>
</ul>
</li>
<li><p>Goal: bring them all within the same range</p></li>
<li><p>Different methods exist</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">RobustScaler</span><span class="p">,</span> <span class="n">Normalizer</span><span class="p">,</span> <span class="n">MaxAbsScaler</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interact_manual</span>

<span class="c1"># Iris dataset with some added noise</span>
<span class="k">def</span> <span class="nf">noisy_iris</span><span class="p">():</span>
    <span class="n">iris</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span> <span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span>
    <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="c1"># add more skew </span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="n">scalers</span> <span class="o">=</span> <span class="p">[</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">RobustScaler</span><span class="p">(),</span> <span class="n">MinMaxScaler</span><span class="p">(),</span> <span class="n">Normalizer</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">),</span> <span class="n">MaxAbsScaler</span><span class="p">()]</span>

<span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">scalers</span><span class="p">):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">noisy_iris</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Use only first 2 features</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;brg&quot;</span><span class="p">)</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">maxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">maxx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="n">maxy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Data&quot;</span><span class="p">)</span>
    
    <span class="n">X_</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;brg&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c9240dda42ab4242a8e6d1b753b5a792", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_scaling</span><span class="p">(</span><span class="n">scalers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="why-do-we-need-scaling">
<h2>Why do we need scaling?<a class="headerlink" href="#why-do-we-need-scaling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>KNN: Distances depend mainly on feature with larger values</p></li>
<li><p>SVMs: (kernelized) dot products are also based on distances</p></li>
<li><p>Linear model: Feature scale affects regularization</p>
<ul>
<li><p>Weights have similar scales, more interpretable</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span><span class="p">,</span> <span class="n">LinearSVC</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_blobs</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">clone</span>

<span class="c1"># Example by Andreas Mueller, with some tweaks</span>
<span class="k">def</span> <span class="nf">plot_2d_classification</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c1"># multiclass                                                                  </span>
    <span class="k">if</span> <span class="n">eps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                                                               
        <span class="n">eps</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eps</span><span class="p">,</span> <span class="n">eps</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                                                                
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>                                                            

    <span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># these should be 1000 but knn predict is unnecessarily slow</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>                                          
    <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>                                          

    <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">)</span>                                                  
    <span class="n">X_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">X1</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">X2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>                                        
    <span class="n">decision_values</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_grid</span><span class="p">)</span>                                  
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">decision_values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span>            
                                                       <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">),</span>             
            <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>     

<span class="n">clfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">KNeighborsClassifier</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">(),</span> <span class="n">LinearSVC</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">10</span><span class="p">)]</span>

<span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">plot_scaling_effect</span><span class="p">(</span><span class="n">classifier</span><span class="o">=</span><span class="n">clfs</span><span class="p">,</span> <span class="n">show_test</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">]):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">centers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> 
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">clf2</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">classifier</span><span class="p">)</span>
    <span class="n">clf_unscaled</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Without scaling. Accuracy:</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clf_unscaled</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">show_test</span><span class="p">:</span> <span class="c1"># Hide test data for simplicity</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span> 
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">clf_scaled</span> <span class="o">=</span> <span class="n">clf2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;With scaling. Accuracy:</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clf_scaled</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span><span class="n">y_test</span><span class="p">)))</span>   
    <span class="k">if</span> <span class="n">show_test</span><span class="p">:</span> <span class="c1"># Hide test data for simplicity</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plot_2d_classification</span><span class="p">(</span><span class="n">clf_unscaled</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
    <span class="n">plot_2d_classification</span><span class="p">(</span><span class="n">clf_scaled</span><span class="p">,</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f8ef6bcb0c8841e9a0be16de193b7f56", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_scaling_effect</span><span class="p">(</span><span class="n">classifier</span><span class="o">=</span><span class="n">clfs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">show_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="standard-scaling-standardization">
<h2>Standard scaling (standardization)<a class="headerlink" href="#standard-scaling-standardization" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Generally most useful, assumes data is more or less normally distributed</p></li>
<li><p>Per feature, subtract the mean value <span class="math notranslate nohighlight">\(\mu\)</span>, scale by standard deviation <span class="math notranslate nohighlight">\(\sigma\)</span></p></li>
<li><p>New feature has <span class="math notranslate nohighlight">\(\mu=0\)</span> and <span class="math notranslate nohighlight">\(\sigma=1\)</span>, values can still be arbitrarily large
$<span class="math notranslate nohighlight">\(\mathbf{x}_{new} = \frac{\mathbf{x} - \mu}{\sigma}\)</span>$</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">StandardScaler</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_10_0.png" src="../_images/06 - Data Preprocessing_10_0.png" />
</div>
</div>
</div>
<div class="section" id="min-max-scaling">
<h2>Min-max scaling<a class="headerlink" href="#min-max-scaling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Scales all features between a given <span class="math notranslate nohighlight">\(min\)</span> and <span class="math notranslate nohighlight">\(max\)</span> value (e.g. 0 and 1)</p></li>
<li><p>Makes sense if min/max values have meaning in your data</p></li>
<li><p>Sensitive to outliers</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\mathbf{x}_{new} = \frac{\mathbf{x} - x_{min}}{x_{max} - x_{min}} \cdot (max - min) + min \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">MinMaxScaler</span><span class="p">(</span><span class="n">feature_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_12_0.png" src="../_images/06 - Data Preprocessing_12_0.png" />
</div>
</div>
</div>
<div class="section" id="robust-scaling">
<h2>Robust scaling<a class="headerlink" href="#robust-scaling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Subtracts the median, scales between quantiles <span class="math notranslate nohighlight">\(q_{25}\)</span> and <span class="math notranslate nohighlight">\(q_{75}\)</span></p></li>
<li><p>New feature has median 0, <span class="math notranslate nohighlight">\(q_{25}=-1\)</span> and <span class="math notranslate nohighlight">\(q_{75}=1\)</span></p></li>
<li><p>Similar to standard scaler, but ignores outliers</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">RobustScaler</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_14_0.png" src="../_images/06 - Data Preprocessing_14_0.png" />
</div>
</div>
</div>
<div class="section" id="normalization">
<h2>Normalization<a class="headerlink" href="#normalization" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Makes sure that feature values of each point (each row) sum up to 1 (L1 norm)</p>
<ul>
<li><p>Useful for count data (e.g. word counts in documents)</p></li>
</ul>
</li>
<li><p>Can also be used with L2 norm (sum of squares is 1)</p>
<ul>
<li><p>Useful when computing distances in high dimensions</p></li>
<li><p>Normalized Euclidean distance is equivalent to cosine similarity</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">Normalizer</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_16_0.png" src="../_images/06 - Data Preprocessing_16_0.png" />
</div>
</div>
</div>
<div class="section" id="maximum-absolute-scaler">
<h2>Maximum Absolute scaler<a class="headerlink" href="#maximum-absolute-scaler" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>For sparse data (many features, but few are non-zero)</p>
<ul>
<li><p>Maintain sparseness (efficient storage)</p></li>
</ul>
</li>
<li><p>Scales all values so that maximum absolute value is 1</p></li>
<li><p>Similar to Min-Max scaling without changing 0 values</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">MaxAbsScaler</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_18_0.png" src="../_images/06 - Data Preprocessing_18_0.png" />
</div>
</div>
</div>
<div class="section" id="power-transformations">
<h2>Power transformations<a class="headerlink" href="#power-transformations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Some features follow certain distributions</p>
<ul>
<li><p>E.g. number of twitter followers is log-normal distributed</p></li>
</ul>
</li>
<li><p>Box-Cox transformations transform these to normal distributions (<span class="math notranslate nohighlight">\(\lambda\)</span> is fitted)</p>
<ul>
<li><p>Only works for positive values, use Yeo-Johnson otherwise
$<span class="math notranslate nohighlight">\(bc_{\lambda}(x) = \begin{cases} log(x) &amp; \lambda = 0\\ \frac{x^{\lambda}-1}{\lambda} &amp; \lambda \neq 0 \\ \end{cases}\)</span>$</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adapted from an example by Eric Chang and Nicolas Hug </span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PowerTransformer</span>

<span class="c1"># Power transformer with Box-Cox</span>
<span class="n">bc</span> <span class="o">=</span> <span class="n">PowerTransformer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;box-cox&#39;</span><span class="p">)</span>

<span class="c1"># Generate data</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span> <span class="c1"># Random number generator</span>
<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">X_lognormal</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># lognormal distribution</span>
<span class="n">X_chisq</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">chisquare</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># chi-squared distribution</span>
<span class="n">X_weibull</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">weibull</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># weibull distribution</span>

<span class="c1"># create plots</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Lognormal&#39;</span><span class="p">,</span> <span class="n">X_lognormal</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Chi-squared&#39;</span><span class="p">,</span> <span class="n">X_chisq</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Weibull&#39;</span><span class="p">,</span> <span class="n">X_weibull</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#D81B60&#39;</span><span class="p">,</span> <span class="s1">&#39;#0188FF&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFC107&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">axes_idxs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
<span class="n">axes_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">axes_idxs</span><span class="p">]</span>

<span class="k">for</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">axes</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">distributions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">distribution</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

    <span class="c1"># perform power transforms and quantile transform</span>
    <span class="n">X_trans_bc</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">lmbda_bc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">lambdas_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">ax_original</span><span class="p">,</span> <span class="n">ax_bc</span> <span class="o">=</span> <span class="n">axes</span>
    <span class="n">ax_original</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">ax_original</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax_original</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span>

    <span class="n">ax_bc</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X_trans_bc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;After </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Box-Cox&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lmbda_bc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39; $\lambda$ = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmbda_bc</span><span class="p">)</span>
    <span class="n">ax_bc</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax_bc</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span>
    <span class="n">ax_bc</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_20_0.png" src="../_images/06 - Data Preprocessing_20_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">heading_properties</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="n">table_font_size</span><span class="p">)]</span>
<span class="n">cell_properties</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="n">table_font_size</span><span class="p">)]</span>
<span class="n">dfstyle</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">heading_properties</span><span class="p">),</span>\
 <span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">cell_properties</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="categorical-feature-encoding">
<h1>Categorical feature encoding<a class="headerlink" href="#categorical-feature-encoding" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Many algorithms can only handle numeric features, so we need to encode the categorical ones</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;boro&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">,</span> <span class="s1">&#39;Queens&#39;</span><span class="p">,</span> <span class="s1">&#39;Manhattan&#39;</span><span class="p">,</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">,</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">,</span> <span class="s1">&#39;Bronx&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;salary&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">219</span><span class="p">]})</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;vegan&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]})</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;vegan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_cf09e678_7ff6_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_cf09e678_7ff6_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_cf09e678_7ff6_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >boro</th>        <th class="col_heading level0 col1" >salary</th>        <th class="col_heading level0 col2" >vegan</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_cf09e678_7ff6_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >Manhattan</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >103</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >0</td>
            </tr>
            <tr>
                        <th id="T_cf09e678_7ff6_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >Queens</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >89</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >0</td>
            </tr>
            <tr>
                        <th id="T_cf09e678_7ff6_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >Manhattan</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >142</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >0</td>
            </tr>
            <tr>
                        <th id="T_cf09e678_7ff6_11eb_8532_8c8590a2facalevel0_row3" class="row_heading level0 row3" >3</th>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow3_col0" class="data row3 col0" >Brooklyn</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow3_col1" class="data row3 col1" >54</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow3_col2" class="data row3 col2" >1</td>
            </tr>
            <tr>
                        <th id="T_cf09e678_7ff6_11eb_8532_8c8590a2facalevel0_row4" class="row_heading level0 row4" >4</th>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow4_col0" class="data row4 col0" >Brooklyn</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow4_col1" class="data row4 col1" >63</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow4_col2" class="data row4 col2" >1</td>
            </tr>
            <tr>
                        <th id="T_cf09e678_7ff6_11eb_8532_8c8590a2facalevel0_row5" class="row_heading level0 row5" >5</th>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow5_col0" class="data row5 col0" >Bronx</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow5_col1" class="data row5 col1" >219</td>
                        <td id="T_cf09e678_7ff6_11eb_8532_8c8590a2facarow5_col2" class="data row5 col2" >0</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="section" id="ordinal-encoding">
<h2>Ordinal encoding<a class="headerlink" href="#ordinal-encoding" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Simply assigns an integer value to each category in the order they are encountered</p></li>
<li><p>Only really useful if there exist a natural order in categories</p>
<ul>
<li><p>Model will consider one category to be ‘higher’ or ‘closer’ to another</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OrdinalEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Encode first feature, rest passthrough</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span>
<span class="n">X_ordinal</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Convert to pandas for nicer output</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_ordinal</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boro_ordinal&quot;</span><span class="p">,</span><span class="s2">&quot;salary&quot;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;boro&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_cf137cc4_7ff6_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_cf137cc4_7ff6_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_cf137cc4_7ff6_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >boro</th>        <th class="col_heading level0 col1" >boro_ordinal</th>        <th class="col_heading level0 col2" >salary</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >Manhattan</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >2</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >103</td>
            </tr>
            <tr>
                        <th id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >Queens</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >3</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >89</td>
            </tr>
            <tr>
                        <th id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >Manhattan</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >2</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >142</td>
            </tr>
            <tr>
                        <th id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facalevel0_row3" class="row_heading level0 row3" >3</th>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow3_col0" class="data row3 col0" >Brooklyn</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow3_col1" class="data row3 col1" >1</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow3_col2" class="data row3 col2" >54</td>
            </tr>
            <tr>
                        <th id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facalevel0_row4" class="row_heading level0 row4" >4</th>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow4_col0" class="data row4 col0" >Brooklyn</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow4_col1" class="data row4 col1" >1</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow4_col2" class="data row4 col2" >63</td>
            </tr>
            <tr>
                        <th id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facalevel0_row5" class="row_heading level0 row5" >5</th>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow5_col0" class="data row5 col0" >Bronx</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow5_col1" class="data row5 col1" >0</td>
                        <td id="T_cf137cc4_7ff6_11eb_8532_8c8590a2facarow5_col2" class="data row5 col2" >219</td>
            </tr>
    </tbody></table></div></div>
</div>
</div>
<div class="section" id="one-hot-encoding-dummy-encoding">
<h2>One-hot encoding (dummy encoding)<a class="headerlink" href="#one-hot-encoding-dummy-encoding" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Simply adds a new 0/1 feature for every category, having 1 (hot) if the sample has that category</p></li>
<li><p>Can explode if a feature has lots of values, causing issues with high dimensionality</p></li>
<li><p>What if test set contains a new category not seen in training data?</p>
<ul>
<li><p>Either ignore it (just use all 0’s in row), or handle manually (e.g. resample)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Encode first feature, rest passthrough</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span>
<span class="n">X_ordinal</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Convert to pandas for nicer output</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_ordinal</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boro_Bronx&quot;</span><span class="p">,</span><span class="s2">&quot;boro_Brooklyn&quot;</span><span class="p">,</span><span class="s2">&quot;boro_Manhattan&quot;</span><span class="p">,</span><span class="s2">&quot;boro_Queens&quot;</span><span class="p">,</span><span class="s2">&quot;salary&quot;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;boro&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_cf1809c4_7ff6_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_cf1809c4_7ff6_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_cf1809c4_7ff6_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >boro</th>        <th class="col_heading level0 col1" >boro_Bronx</th>        <th class="col_heading level0 col2" >boro_Brooklyn</th>        <th class="col_heading level0 col3" >boro_Manhattan</th>        <th class="col_heading level0 col4" >boro_Queens</th>        <th class="col_heading level0 col5" >salary</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >Manhattan</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow0_col3" class="data row0 col3" >1</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow0_col4" class="data row0 col4" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow0_col5" class="data row0 col5" >103</td>
            </tr>
            <tr>
                        <th id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >Queens</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow1_col3" class="data row1 col3" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow1_col4" class="data row1 col4" >1</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow1_col5" class="data row1 col5" >89</td>
            </tr>
            <tr>
                        <th id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >Manhattan</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow2_col3" class="data row2 col3" >1</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow2_col4" class="data row2 col4" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow2_col5" class="data row2 col5" >142</td>
            </tr>
            <tr>
                        <th id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facalevel0_row3" class="row_heading level0 row3" >3</th>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow3_col0" class="data row3 col0" >Brooklyn</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow3_col1" class="data row3 col1" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow3_col2" class="data row3 col2" >1</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow3_col3" class="data row3 col3" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow3_col4" class="data row3 col4" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow3_col5" class="data row3 col5" >54</td>
            </tr>
            <tr>
                        <th id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facalevel0_row4" class="row_heading level0 row4" >4</th>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow4_col0" class="data row4 col0" >Brooklyn</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow4_col1" class="data row4 col1" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow4_col2" class="data row4 col2" >1</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow4_col3" class="data row4 col3" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow4_col4" class="data row4 col4" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow4_col5" class="data row4 col5" >63</td>
            </tr>
            <tr>
                        <th id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facalevel0_row5" class="row_heading level0 row5" >5</th>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow5_col0" class="data row5 col0" >Bronx</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow5_col1" class="data row5 col1" >1</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow5_col2" class="data row5 col2" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow5_col3" class="data row5 col3" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow5_col4" class="data row5 col4" >0</td>
                        <td id="T_cf1809c4_7ff6_11eb_8532_8c8590a2facarow5_col5" class="data row5 col5" >219</td>
            </tr>
    </tbody></table></div></div>
</div>
</div>
<div class="section" id="target-encoding">
<h2>Target encoding<a class="headerlink" href="#target-encoding" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Value close to 1 if category correlates with class 1, close to 0 if correlates with class 0</p></li>
<li><p>Preferred when you have lots of category values. It only creates one new feature per class</p></li>
<li><p>Blends posterior probability of the target <span class="math notranslate nohighlight">\(\frac{n_{iY}}{n_i}\)</span> and prior probability <span class="math notranslate nohighlight">\(\frac{n_Y}{n}\)</span>.</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(n_{iY}\)</span>: nr of samples with category i and class Y=1, <span class="math notranslate nohighlight">\(n_{i}\)</span>: nr of samples with category i</p></li>
<li><p>Blending: gradually decrease as you get more examples of category i and class Y=0
$<span class="math notranslate nohighlight">\(Enc(i) = \color{blue}{\frac{1}{1+e^{-(n_{i}-1)}} \frac{n_{iY}}{n_i}} + \color{green}{(1-\frac{1}{1+e^{-(n_{i}-1)}}) \frac{n_Y}{n}}\)</span>$</p></li>
<li><p>Same for regression, using <span class="math notranslate nohighlight">\(\frac{n_{iY}}{n_i}\)</span>: average target value with category i, <span class="math notranslate nohighlight">\(\frac{n_{Y}}{n}\)</span>: overall mean</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># smoothed sigmoid</span>
<span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">smoothing</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">plot_blend</span><span class="p">():</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># 20 points</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># 10 points of class Yes</span>
    <span class="n">niy</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># number of points of category i and class Yes</span>
    <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">niy</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> <span class="c1">#  10 points of category i</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">niy</span><span class="o">/</span><span class="n">ni</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;posterior term&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ni</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="n">n</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;prior term&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">niy</span><span class="o">/</span><span class="n">ni</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="n">n</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;blend&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$n_</span><span class="si">{i}</span><span class="s2">$ ($n_</span><span class="si">{iY}</span><span class="s2"> = 2$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Encoding for Y=1&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">plot_blend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_29_0.png" src="../_images/06 - Data Preprocessing_29_0.png" />
</div>
</div>
<div class="section" id="example">
<h3>Example:<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>For Brooklyn, <span class="math notranslate nohighlight">\(n_{iY}=2, n_{i}=2, n_{Y}=2, n=6\)</span></p></li>
<li><p>Would be closer to 1 if there were more examples, all with label 1
$<span class="math notranslate nohighlight">\(Enc(Brooklyn) = \frac{1}{1+e^{-1}} \frac{2}{2} + (1-\frac{1}{1+e^{-1}}) \frac{2}{6}  = 0,82\)</span>$</p></li>
<li><p>Note: the implementation used here sets <span class="math notranslate nohighlight">\(Enc(i)=\frac{n_Y}{n}\)</span> when <span class="math notranslate nohighlight">\(n_{iY}=1\)</span></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not in sklearn yet, use package category_encoders</span>
<span class="kn">from</span> <span class="nn">category_encoders</span> <span class="kn">import</span> <span class="n">TargetEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">TargetEncoder</span><span class="p">(</span><span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">pd_te</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Convert to pandas for nicer output</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pd_te</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boro&quot;</span><span class="p">,</span><span class="s2">&quot;salary&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;boro&#39;</span><span class="p">:</span> <span class="s1">&#39;boro_encoded&#39;</span><span class="p">})</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;boro&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_cf99eba6_7ff6_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_cf99eba6_7ff6_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_cf99eba6_7ff6_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >boro</th>        <th class="col_heading level0 col1" >boro_encoded</th>        <th class="col_heading level0 col2" >salary</th>        <th class="col_heading level0 col3" >vegan</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >Manhattan</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >0.09</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >103</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow0_col3" class="data row0 col3" >0</td>
            </tr>
            <tr>
                        <th id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >Queens</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >0.33</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >89</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow1_col3" class="data row1 col3" >0</td>
            </tr>
            <tr>
                        <th id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >Manhattan</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >0.09</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >142</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow2_col3" class="data row2 col3" >0</td>
            </tr>
            <tr>
                        <th id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facalevel0_row3" class="row_heading level0 row3" >3</th>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow3_col0" class="data row3 col0" >Brooklyn</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow3_col1" class="data row3 col1" >0.82</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow3_col2" class="data row3 col2" >54</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow3_col3" class="data row3 col3" >1</td>
            </tr>
            <tr>
                        <th id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facalevel0_row4" class="row_heading level0 row4" >4</th>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow4_col0" class="data row4 col0" >Brooklyn</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow4_col1" class="data row4 col1" >0.82</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow4_col2" class="data row4 col2" >63</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow4_col3" class="data row4 col3" >1</td>
            </tr>
            <tr>
                        <th id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facalevel0_row5" class="row_heading level0 row5" >5</th>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow5_col0" class="data row5 col0" >Bronx</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow5_col1" class="data row5 col1" >0.33</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow5_col2" class="data row5 col2" >219</td>
                        <td id="T_cf99eba6_7ff6_11eb_8532_8c8590a2facarow5_col3" class="data row5 col3" >0</td>
            </tr>
    </tbody></table></div></div>
</div>
</div>
</div>
<div class="section" id="in-practice-scikit-learn">
<h2>In practice (scikit-learn)<a class="headerlink" href="#in-practice-scikit-learn" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Ordinal encoding and one-hot encoding are implemented in scikit-learn</p>
<ul>
<li><p>dtype defines that the output should be an integer</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ordinal_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">one_hot_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Target encoding is available in <code class="docutils literal notranslate"><span class="pre">category_encoders</span></code></p>
<ul>
<li><p>scikit-learn compatible</p></li>
<li><p>Also includes other, very specific encoders</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">target_encoder</span> <span class="o">=</span> <span class="n">TargetEncoder</span><span class="p">(</span><span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>All encoders (and scalers) follow the <code class="docutils literal notranslate"><span class="pre">fit-transform</span></code> paradigm</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">fit</span></code> prepares the encoder, <code class="docutils literal notranslate"><span class="pre">transform</span></code> actually encodes the features</p></li>
<li><p>We’ll discuss this next</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">X_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="applying-data-transformations">
<h1>Applying data transformations<a class="headerlink" href="#applying-data-transformations" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Data transformations should always follow a fit-predict paradigm</p>
<ul>
<li><p>Fit the transformer on the training data only</p>
<ul>
<li><p>E.g. for a standard scaler: record the mean and standard deviation</p></li>
</ul>
</li>
<li><p>Transform (e.g. scale) the training data, then train the learning model</p></li>
<li><p>Transform (e.g. scale) the test data, then evaluate the model</p></li>
</ul>
</li>
<li><p>Only scale the input features (X), not the targets (y)</p></li>
<li><p>If you fit and transform the whole dataset before splitting, you get data leakage</p>
<ul>
<li><p>You have looked at the test data before training the model</p></li>
<li><p>Model evaluations will be misleading</p></li>
</ul>
</li>
<li><p>If you fit and transform the training and test data separately, you distort the data</p>
<ul>
<li><p>E.g. training and test points are scaled differently</p></li>
</ul>
</li>
</ul>
<div class="section" id="id1">
<h2>In practice (scikit-learn)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># choose scaling method and fit on training data</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="c1"># transform training and test data</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># calling fit and transform in sequence</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="c1"># same result, but more efficient computation</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="test-set-distortion-example">
<h2>Test set distortion example<a class="headerlink" href="#test-set-distortion-example" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Properly scaled: <code class="docutils literal notranslate"><span class="pre">fit</span></code> on training set, <code class="docutils literal notranslate"><span class="pre">transform</span></code> on training and test set</p></li>
<li><p>Improperly scaled: <code class="docutils literal notranslate"><span class="pre">fit</span></code> and <code class="docutils literal notranslate"><span class="pre">transform</span></code> on the training and test data separately</p>
<ul>
<li><p>Test data points nowhere near same training data points</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.axes._axes</span> <span class="kn">import</span> <span class="n">_log</span> <span class="k">as</span> <span class="n">matplotlib_axes_logger</span>
<span class="n">matplotlib_axes_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_blobs</span>
<span class="c1"># make synthetic data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cluster_std</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># split it into training and test set</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>

<span class="c1"># plot the training and test set</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Data&quot;</span><span class="p">)</span>

<span class="c1"># scale the data using MinMaxScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># visualize the properly scaled data</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Scaled Data&quot;</span><span class="p">)</span>

<span class="c1"># rescale the test set separately</span>
<span class="c1"># so that test set min is 0 and test set max is 1</span>
<span class="c1"># DO NOT DO THIS! For illustration purposes only</span>
<span class="n">test_scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">test_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">X_test_scaled_badly</span> <span class="o">=</span> <span class="n">test_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># visualize wrongly scaled data</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;training set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test_scaled_badly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test_scaled_badly</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Improperly Scaled Data&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Feature 0&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Feature 1&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_37_0.png" src="../_images/06 - Data Preprocessing_37_0.png" />
</div>
</div>
</div>
<div class="section" id="data-leakage-example">
<h2>Data leakage example<a class="headerlink" href="#data-leakage-example" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Cross-validation: training set is split into training and validation sets for model selection</p></li>
<li><p>Incorrect: Scaler is fit on whole training set before doing cross-validation</p>
<ul>
<li><p>Data leaks from validation folds into training folds, selected model may be optimistic</p></li>
</ul>
</li>
<li><p>Right: Scaler is fit on training folds only</p></li>
</ul>
<img src="../images/infoleak.png" alt="ml" style="width: 1500px;"/></div>
</div>
<div class="section" id="pipelines">
<h1>Pipelines<a class="headerlink" href="#pipelines" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>A pipeline is a combination of data transformation and learning algorithms</p></li>
<li><p>It has a <code class="docutils literal notranslate"><span class="pre">fit</span></code>, <code class="docutils literal notranslate"><span class="pre">predict</span></code>, and <code class="docutils literal notranslate"><span class="pre">score</span></code> method, just like any other learning algorithm</p>
<ul>
<li><p>Ensures that data transformations are applied correctly</p></li>
</ul>
</li>
</ul>
<img src="../images/07_pipelines.png" alt="ml" style="width: 600px;"/><div class="section" id="id2">
<h2>In practice (scikit-learn)<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">pipeline</span></code> combines multiple processing <em>steps</em> in a single estimator</p></li>
<li><p>All but the last step should be data transformer (have a <code class="docutils literal notranslate"><span class="pre">transform</span></code> method)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make pipeline, step names will be &#39;minmaxscaler&#39; and &#39;linearsvc&#39;</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">MinMaxScaler</span><span class="p">(),</span> <span class="n">LinearSVC</span><span class="p">())</span>
<span class="c1"># Build pipeline with named steps </span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s2">&quot;scaler&quot;</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;svm&quot;</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">())])</span>

<span class="c1"># Correct fit and score</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="c1"># Retrieve trained model by name</span>
<span class="n">svm</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;svm&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct cross-validation</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="in-practice-scikit-learn-continued">
<h2>In practice (scikit-learn), continued<a class="headerlink" href="#in-practice-scikit-learn-continued" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>If you want to apply different preprocessors to different columns, use <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code></p></li>
<li><p>If you want to merge pipelines, you can use <code class="docutils literal notranslate"><span class="pre">FeatureUnion</span></code> to concatenate columns</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 2 sub-pipelines, one for numeric features, other for categorical ones</span>
<span class="n">numeric_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(),</span><span class="n">StandardScaler</span><span class="p">())</span>
<span class="n">categorical_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(),</span><span class="n">OneHotEncoder</span><span class="p">())</span>

<span class="c1"># Using categorical pipe for features A,B,C, numeric pipe otherwise</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">categorical_pipe</span><span class="p">,[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span><span class="s2">&quot;B&quot;</span><span class="p">,</span><span class="s2">&quot;C&quot;</span><span class="p">]),</span> 
                                       <span class="n">remainder</span><span class="o">=</span><span class="n">numeric_pipe</span><span class="p">)</span>

<span class="c1"># Combine with learning algorithm in another pipeline</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocess</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Feature union of PCA features and selected features</span>
<span class="n">union</span> <span class="o">=</span> <span class="n">FeatureUnion</span><span class="p">([(</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> <span class="n">PCA</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="n">SelectKBest</span><span class="p">())])</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">union</span><span class="p">,</span> <span class="n">LinearSVC</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>In practice (scikit-learn), continued<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code> concatenates features in order</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">((</span><span class="n">StandardScaler</span><span class="p">(),</span><span class="n">numeric_features</span><span class="p">),</span> 
                               <span class="p">(</span><span class="n">PCA</span><span class="p">(),</span><span class="n">numeric_features</span><span class="p">),</span>  
                               <span class="p">(</span><span class="n">OneHotEncoder</span><span class="p">(),</span><span class="n">categorical_features</span><span class="p">))</span>
</pre></div>
</div>
<img src="../images/columntransformer.png" alt="ml" style="width: 900px;"/></div>
<div class="section" id="model-selection-scikit-learn">
<h2>Model selection (scikit-learn)<a class="headerlink" href="#model-selection-scikit-learn" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We can safely use pipelines in model selection (e.g. grid search)</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">'__'</span></code> to refer to the hyperparameters of a step, e.g. <code class="docutils literal notranslate"><span class="pre">svm__C</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Correct grid search (can have hyperparameters of any step)</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;svm__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
              <span class="s1">&#39;svm__gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="c1"># Best estimator is now the best pipeline</span>
<span class="n">best_pipe</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">best_estimator_</span>

<span class="c1"># Tune pipeline and evaluate on held-out test set</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">)</span>

</pre></div>
</div>
<div class="section" id="example-tune-multiple-steps-at-once">
<h3>Example: Tune multiple steps at once<a class="headerlink" href="#example-tune-multiple-steps-at-once" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span><span class="n">PolynomialFeatures</span><span class="p">(),</span> <span class="n">Ridge</span><span class="p">())</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polynomialfeatures__degree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
              <span class="s1">&#39;ridge__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_boston</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>
<span class="n">boston</span> <span class="o">=</span> <span class="n">load_boston</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">boston</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">boston</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                    <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span><span class="n">PolynomialFeatures</span><span class="p">(),</span><span class="n">Ridge</span><span class="p">())</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;polynomialfeatures__degree&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
              <span class="s1">&#39;ridge__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>

<span class="c1">#plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s1">&#39;mean_test_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ridge__alpha&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;polynomialfeatures__degree&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;ridge__alpha&#39;</span><span class="p">])))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;ridge__alpha&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;polynomialfeatures__degree&#39;</span><span class="p">])))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">param_grid</span><span class="p">[</span><span class="s1">&#39;polynomialfeatures__degree&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_48_0.png" src="../_images/06 - Data Preprocessing_48_0.png" />
</div>
</div>
</div>
</div>
</div>
<div class="section" id="automatic-feature-selection">
<h1>Automatic Feature Selection<a class="headerlink" href="#automatic-feature-selection" title="Permalink to this headline">¶</a></h1>
<p>It can be a good idea to reduce the number of features to only the most useful ones</p>
<ul class="simple">
<li><p>Simpler models that generalize better (less overfitting)</p>
<ul>
<li><p>Curse of dimensionality (e.g. kNN)</p></li>
<li><p>Even models such as RandomForest can benefit from this</p></li>
<li><p>Sometimes it is one of the main methods to improve models (e.g. gene expression data)</p></li>
</ul>
</li>
<li><p>Faster prediction and training</p>
<ul>
<li><p>Training time can be quadratic (or cubic) in number of features</p></li>
</ul>
</li>
<li><p>Easier data collection, smaller models (less storage)</p></li>
<li><p>More interpretable models: fewer features to look at</p></li>
</ul>
<div class="section" id="example-bike-sharing">
<h2>Example: bike sharing<a class="headerlink" href="#example-bike-sharing" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The Bike Sharing Demand dataset shows the amount of bikes rented in Washington DC</p></li>
<li><p>Some features are clearly more informative than others (e.g. temp, hour)</p></li>
<li><p>Some are correlated (e.g. temp and feel_temp)</p></li>
<li><p>We add two random features at the end</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="c1"># Get bike sharing data from OpenML</span>
<span class="n">bikes</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="mi">42713</span><span class="p">,</span> <span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_bike_cat</span><span class="p">,</span> <span class="n">y_bike</span> <span class="o">=</span> <span class="n">bikes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bikes</span><span class="o">.</span><span class="n">target</span>

<span class="c1"># One-hot encode the categorical features</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">])],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span>
<span class="n">X_bike</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_bike_cat</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Add 2 random features at the end</span>
<span class="n">random_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_bike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span><span class="n">random_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create feature names</span>
<span class="n">bike_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;summer&#39;</span><span class="p">,</span><span class="s1">&#39;winter&#39;</span><span class="p">,</span> <span class="s1">&#39;spring&#39;</span><span class="p">,</span> <span class="s1">&#39;fall&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">,</span> <span class="s1">&#39;misty&#39;</span><span class="p">,</span> <span class="s1">&#39;rain&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy_rain&#39;</span><span class="p">]</span>
<span class="n">bike_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_bike_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">bike_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_bike_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span>
<span class="n">bike_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;random_1&#39;</span><span class="p">,</span><span class="s1">&#39;random_2&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pd.set_option(&#39;display.max_columns&#39;, 20)</span>
<span class="c1">#pd.DataFrame(data=X_bike, columns=bike_names).head()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_bike</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">y_bike</span><span class="p">[:],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bike_names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_53_0.png" src="../_images/06 - Data Preprocessing_53_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fig, ax = plt.subplots(figsize=(6, 2))</span>
<span class="c1">#ax.plot(X_bike[:, 2])</span>
<span class="c1">#ax.plot(X_bike[:, 14])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="unsupervised-feature-selection">
<h2>Unsupervised feature selection<a class="headerlink" href="#unsupervised-feature-selection" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Variance-based</p>
<ul>
<li><p>Remove (near) constant features</p>
<ul>
<li><p>Choose a small variance threshold</p></li>
</ul>
</li>
<li><p>Scale features before computing variance!</p></li>
<li><p>Infrequent values may still be important</p></li>
</ul>
</li>
<li><p>Covariance-based</p>
<ul>
<li><p>Remove correlated features</p></li>
<li><p>The small differences may actually be important</p>
<ul>
<li><p>You don’t know because you don’t consider the target</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">VarianceThreshold</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">VarianceThreshold</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">MinMaxScaler</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_bike</span><span class="p">))</span>
<span class="n">variances</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">variances_</span>
<span class="n">var_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">ypos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span> <span class="n">variances</span><span class="p">[</span><span class="n">var_sort</span><span class="p">][:</span><span class="mi">6</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bike_names</span><span class="p">)[</span><span class="n">var_sort</span><span class="p">][:</span><span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Variance&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_56_0.png" src="../_images/06 - Data Preprocessing_56_0.png" />
</div>
</div>
<div class="section" id="covariance-based-feature-selection">
<h3>Covariance based feature selection<a class="headerlink" href="#covariance-based-feature-selection" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Remove features <span class="math notranslate nohighlight">\(X_i\)</span> (= <span class="math notranslate nohighlight">\(\mathbf{X_{:,i}}\)</span>) that are highly correlated (have high correlation coefficient <span class="math notranslate nohighlight">\(\rho\)</span>)
$<span class="math notranslate nohighlight">\(\rho (X_1,X_2)={\frac  {{\mathrm  {cov}}(X_1,X_2)}{\sigma (X_1)\sigma (X_2)}} = {\frac { \frac{1}{N-1} \sum_i (X_{i,1} - \overline{X_1})(X_{i,2} - \overline{X_2}) }{\sigma (X_1)\sigma (X_2)}}\)</span>$</p></li>
<li><p>Should we remove <code class="docutils literal notranslate"><span class="pre">feel_temp</span></code>? Or <code class="docutils literal notranslate"><span class="pre">temp</span></code>? Maybe one correlates more with the target?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">scale</span>
<span class="kn">from</span> <span class="nn">scipy.cluster</span> <span class="kn">import</span> <span class="n">hierarchy</span>

<span class="n">X_bike_scaled</span> <span class="o">=</span> <span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">X_bike_scaled</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">hierarchy</span><span class="o">.</span><span class="n">ward</span><span class="p">(</span><span class="n">cov</span><span class="p">),</span> <span class="n">no_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;ivl&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<span class="n">bike_names_ordered</span> <span class="o">=</span> <span class="p">[</span><span class="n">bike_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.2</span><span class="p">,</span> <span class="mf">4.2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">order</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X_bike</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bike_names_ordered</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X_bike</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bike_names_ordered</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_58_0.png" src="../_images/06 - Data Preprocessing_58_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">f_regression</span><span class="p">,</span> <span class="n">SelectPercentile</span><span class="p">,</span> <span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">SelectFromModel</span><span class="p">,</span> <span class="n">RFE</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">RidgeCV</span><span class="p">,</span> <span class="n">LassoCV</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">mlxtend.feature_selection</span> <span class="kn">import</span> <span class="n">SequentialFeatureSelector</span>
<span class="kn">from</span> <span class="nn">sklearn.inspection</span> <span class="kn">import</span> <span class="n">permutation_importance</span>

<span class="c1"># Pre-compute all importances on bike sharing dataset</span>
<span class="c1"># Scaled feature selection thresholds</span>
<span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="c1"># Dict to store all data</span>
<span class="n">fs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">,</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">,</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span><span class="s1">&#39;Ridge&#39;</span><span class="p">,</span><span class="s1">&#39;Lasso&#39;</span><span class="p">,</span><span class="s1">&#39;RFE&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ForwardSelection&#39;</span><span class="p">,</span><span class="s1">&#39;FloatingForwardSelection&#39;</span><span class="p">,</span><span class="s1">&#39;Permutation&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span> <span class="c1">#RidgeCV() #RandomForestRegressor(n_estimators=100) </span>
    <span class="n">select_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">selector</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">select_pipe</span><span class="p">,</span> <span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Tuned RF (pre-computed to save time)</span>
<span class="c1"># param_grid = {&quot;max_features&quot;:[2,4,8,16],&quot;max_depth&quot;:[8,16,32,64,128]}</span>
<span class="c1"># randomforestCV = GridSearchCV(RandomForestRegressor(n_estimators=200),</span>
<span class="c1">#                              param_grid=param_grid).fit(X_bike, y_bike).best_estimator_</span>
<span class="n">randomforestCV</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">max_features</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="c1"># F test</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing F test&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;F test&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_regression</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span><span class="n">y_bike</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectPercentile</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">f_regression</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">t</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span> <span class="n">y_bike</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>

<span class="c1"># Mutual information</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Mutual information&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Mutual Information&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutual_info_regression</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span><span class="n">y_bike</span><span class="p">,</span><span class="n">discrete_features</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span> <span class="c1"># first 13 features are discrete</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectPercentile</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">t</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span> <span class="n">y_bike</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
    
<span class="c1"># Random Forest</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Random Forest&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Random Forest&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">randomforestCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">randomforestCV</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">*mean&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span> <span class="c1"># Threshold can&#39;t be easily scaled here</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
    
<span class="c1"># Ridge, Lasso</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RidgeCV</span><span class="p">(),</span><span class="n">LassoCV</span><span class="p">()]:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span><span class="o">.</span><span class="n">coef_</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]))</span> <span class="c1"># Use absolute values</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">*mean&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span> <span class="n">y_bike</span><span class="p">)</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        
<span class="c1"># Recursive Feature Elimination</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing RFE&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Recursive Feature Elimination (with RandomForest)&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span><span class="o">.</span><span class="n">ranking_</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span><span class="o">/</span> <span class="mi">19</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">20</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">support_</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>

<span class="c1"># Sequential Feature Selection</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Forward selection&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">floating</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">ForwardSelection&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Floating&quot;</span> <span class="k">if</span> <span class="n">floating</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (with Ridge)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="c1"># There is no scoring here</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">SequentialFeatureSelector</span><span class="p">(</span><span class="n">RidgeCV</span><span class="p">(),</span> <span class="n">k_features</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">20</span><span class="p">),</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">floating</span><span class="o">=</span><span class="n">floating</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">selector</span><span class="o">.</span><span class="n">k_feature_idx_</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        
<span class="c1"># Permutation Importance  </span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Permutation importance&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Permutation importance (with RandomForest))&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">),</span> <span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">,</span> 
                                                    <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">importances_mean</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="n">sorted_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="c1"># inverted sort</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_idx</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">20</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="c1"># Hard to use this in a pipeline, resorting to transforming the data beforehand</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">X_bike</span><span class="p">[:,</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_bike</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing F test
Computing Mutual information
Computing Random Forest
Computing Ridge
Computing Lasso
Computing RFE
Computing Forward selection
Computing Permutation importance
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="o">=</span><span class="s1">&#39;f_test&#39;</span><span class="p">,</span> <span class="n">method2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    
    <span class="c1"># Plot scores</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="n">method1</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method2</span><span class="p">:</span>
        <span class="n">imp2</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="n">method2</span><span class="p">]</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">]</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask2</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">],[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (Ridge R2:</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">]),</span>
                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (Ridge R2:</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">])],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">m1</span><span class="p">],[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (Ridge R2:</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">])],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bike_names</span><span class="p">)))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">bike_names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feature importance (selection threshold </span><span class="si">{:.2f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
                        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="supervised-feature-selection-overview">
<h2>Supervised feature selection: overview<a class="headerlink" href="#supervised-feature-selection-overview" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Univariate: F-test and Mutual Information</p></li>
<li><p>Model-based: Random Forests, Linear models, kNN</p></li>
<li><p>Wrapping techniques (black-box search)</p></li>
<li><p>Permutation importance</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">compare_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">method2</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)):</span>
    <span class="n">plot_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span><span class="n">method2</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2baf770ca79f439487d3f0b57f8f9f0d", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</div>
<div class="section" id="univariate-statistics-f-test">
<h2>Univariate statistics (F-test)<a class="headerlink" href="#univariate-statistics-f-test" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Consider each feature individually (univariate), independent of the model that you aim to apply</p></li>
<li><p>Use a statistical test: is there a <em>linear</em> <strong>statistically significant relationship</strong> with the target?</p></li>
<li><p>Use F-statistic (or corresponding p value) to rank all features, then select features using a threshold</p>
<ul>
<li><p>Best <span class="math notranslate nohighlight">\(k\)</span>, best <span class="math notranslate nohighlight">\(k\)</span> %, probability of removing useful features (FPR),…</p></li>
</ul>
</li>
<li><p>Cannot detect correlations (e.g. temp and feel_temp) or interactions (e.g. binary features)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;FTest&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_64_0.png" src="../_images/06 - Data Preprocessing_64_0.png" />
</div>
</div>
<div class="section" id="f-statistic">
<h3>F-statistic<a class="headerlink" href="#f-statistic" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>For regression: does feature <span class="math notranslate nohighlight">\(X_i\)</span> correlate (positively or negatively) with the target <span class="math notranslate nohighlight">\(y\)</span>?
$<span class="math notranslate nohighlight">\(\text{F-statistic} = \frac{\rho(X_i,y)^2}{1-\rho(X_i,y)^2} \cdot (N-1)\)</span>$</p></li>
<li><p>For classification: uses ANOVA: does <span class="math notranslate nohighlight">\(X_i\)</span> explain the between-class variance?</p>
<ul>
<li><p>Alternatively, use the <span class="math notranslate nohighlight">\(\chi^2\)</span> test (only for categorical features)
$<span class="math notranslate nohighlight">\(\text{F-statistic} = \frac{\text{within-class variance}}{\text{between-class variance}} =\frac{var(\overline{X_i})}{\overline{var(X_i)}}\)</span>$
<img src="../images/03_fstatistic2.png" alt="ml" style="width: 400px;"/></p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="mutual-information">
<h2>Mutual information<a class="headerlink" href="#mutual-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Measures how much information <span class="math notranslate nohighlight">\(X_i\)</span> gives about the target <span class="math notranslate nohighlight">\(Y\)</span>. In terms of entropy <span class="math notranslate nohighlight">\(H\)</span>:
$<span class="math notranslate nohighlight">\(MI(X,Y) = H(X) + H(Y) - H(X,Y)\)</span>$</p></li>
<li><p>Idea: estimate H(X) as the average distance between a data point and its <span class="math notranslate nohighlight">\(k\)</span> Nearest Neighbors</p>
<ul>
<li><p>You need to choose <span class="math notranslate nohighlight">\(k\)</span> and say which features are categorical</p></li>
</ul>
</li>
<li><p>Captures complex dependencies (e.g. hour, month), but requires more samples to be accurate</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">,</span> <span class="s1">&#39;FTest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_67_0.png" src="../_images/06 - Data Preprocessing_67_0.png" />
</div>
</div>
</div>
<div class="section" id="model-based-feature-selection">
<h2>Model-based Feature Selection<a class="headerlink" href="#model-based-feature-selection" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Use a <a class="reference external" href="https://explained.ai/rf-importance/index.html">tuned</a>(!) supervised model to judge the importance of each feature</p>
<ul>
<li><p>Linear models (Ridge, Lasso, LinearSVM,…): features with highest weights (coefficients)</p></li>
<li><p>Tree–based models: features used in first nodes (high information gain)</p></li>
</ul>
</li>
<li><p>Selection model can be different from the one you use for final modelling</p></li>
<li><p>Captures interactions: features are more/less informative in combination (e.g. winter, temp)</p></li>
<li><p>RandomForests: learns complex interactions (e.g. hour), but biased to high cardinality features</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span> <span class="s1">&#39;Lasso&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_69_0.png" src="../_images/06 - Data Preprocessing_69_0.png" />
</div>
</div>
</div>
<div class="section" id="relief-model-based-selection-with-knn">
<h2>Relief: Model-based selection with kNN<a class="headerlink" href="#relief-model-based-selection-with-knn" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>For I iterations, choose a random point <span class="math notranslate nohighlight">\(\mathbf{x_i}\)</span> and find <span class="math notranslate nohighlight">\(k\)</span> nearest neighbors <span class="math notranslate nohighlight">\(\mathbf{x_{k}}\)</span></p></li>
<li><p>Increase feature weights if <span class="math notranslate nohighlight">\(\mathbf{x_i}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{x_{k}}\)</span> have different class (near miss), else decrease</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\mathbf{w_i} = \mathbf{w_{i-1}} + (\mathbf{x_i} - \text{nearMiss}_i)^2 - (\mathbf{x_i} - \text{nearHit}_i)^2\)</span></p></li>
</ul>
</li>
<li><p>Many variants: ReliefF (uses L1 norm, faster), RReliefF (for regression), …</p></li>
</ul>
<img src="../images/relief.png" alt="ml" style="width: 350px;"/></div>
<div class="section" id="model-based-feature-selection-iterative">
<h2>Model-based Feature Selection (iterative)<a class="headerlink" href="#model-based-feature-selection-iterative" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Dropping many features at once is not ideal: feature importance may change in subset</p></li>
<li><p>Recursive Feature Elimination (RFE)</p>
<ul>
<li><p>Remove <span class="math notranslate nohighlight">\(s\)</span> least important feature(s), recompute remaining importances, repeat</p></li>
</ul>
</li>
<li><p>Can be rather slow</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;RFE&#39;</span><span class="p">,</span> <span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_72_0.png" src="../_images/06 - Data Preprocessing_72_0.png" />
</div>
</div>
</div>
<div class="section" id="sequential-feature-selection-wrapping">
<h2>Sequential feature selection (Wrapping)<a class="headerlink" href="#sequential-feature-selection-wrapping" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Evaluate your model with different sets of features, find best subset based on performance</p></li>
<li><p>Greedy black-box search (can end up in local minima)</p>
<ul>
<li><p>Backward selection: remove least important feature, recompute importances, repeat</p></li>
<li><p>Forward selection: set aside most important feature, recompute importances, repeat</p></li>
<li><p>Floating: add best new feature, remove worst one, repeat (forward or backward)</p></li>
</ul>
</li>
<li><p>Stochastic search: use random mutations in candidate subset (e.g. simulated annealing)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;ForwardSelection&#39;</span><span class="p">,</span> <span class="s1">&#39;Ridge&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_74_0.png" src="../_images/06 - Data Preprocessing_74_0.png" />
</div>
</div>
</div>
<div class="section" id="permutation-feature-importance">
<h2>Permutation feature importance<a class="headerlink" href="#permutation-feature-importance" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Defined as the decrease in model performance when a single feature value is randomly shuffled</p>
<ul>
<li><p>This breaks the relationship between the feature and the target</p></li>
</ul>
</li>
<li><p>Model agnostic, metric agnostic, and can be calculated many times with different permutations</p></li>
<li><p>Can be applied to unseen data (not possible with model-based techniques)</p></li>
<li><p>Less biased towards high-cardinality features (compared with RandomForests)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;Permutation&#39;</span><span class="p">,</span> <span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_76_0.png" src="../_images/06 - Data Preprocessing_76_0.png" />
</div>
</div>
</div>
<div class="section" id="comparison">
<h2>Comparison<a class="headerlink" href="#comparison" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Feature importances (scaled) and cross-validated <span class="math notranslate nohighlight">\(R^2\)</span> score of pipeline</p>
<ul>
<li><p>Pipeline contains features selection + Ridge</p></li>
</ul>
</li>
<li><p>Selection threshold value ranges from 25% to 100% of all features</p></li>
<li><p>Best method ultimately depends on the problem and dataset at hand</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">compare_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">method2</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)):</span>
    <span class="n">plot_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span><span class="n">method2</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5784cc071e5e47e590a271c4edbce323", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;Permutation&#39;</span><span class="p">,</span> <span class="s1">&#39;FTest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h3>In practice (scikit-learn)<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Unsupervised: <code class="docutils literal notranslate"><span class="pre">VarianceTreshold</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">VarianceThreshold</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">variances</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">variances_</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Univariate:</p>
<ul>
<li><p>For regression: <code class="docutils literal notranslate"><span class="pre">f_regression</span></code>, <code class="docutils literal notranslate"><span class="pre">mutual_info_regression</span></code></p></li>
<li><p>For classification: <code class="docutils literal notranslate"><span class="pre">f_classification</span></code>, <code class="docutils literal notranslate"><span class="pre">chi2</span></code>, <code class="docutils literal notranslate"><span class="pre">mutual_info_classication</span></code></p></li>
<li><p>Selecting: <code class="docutils literal notranslate"><span class="pre">SelectKBest</span></code>, <code class="docutils literal notranslate"><span class="pre">SelectPercentile</span></code>, <code class="docutils literal notranslate"><span class="pre">SelectFpr</span></code>,…</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SelectPercentile</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">f_regression</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
<span class="n">f_values</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">f_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">mi_values</span> <span class="o">=</span> <span class="n">mutual_info_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">discrete_features</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>In practice (scikit-learn)<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Model-based:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SelectFromModel</span></code>: requires a model and a selection threshold</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RFE</span></code>, <code class="docutils literal notranslate"><span class="pre">RFECV</span></code> (recursive feature elimination): requires model and final nr features</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">rfe_selector</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">RidgeCV</span><span class="p">(),</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">rf_importances</span> <span class="o">=</span> <span class="n">Randomforest</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Sequential feature selection (from <code class="docutils literal notranslate"><span class="pre">mlxtend</span></code>, sklearn-compatible)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SequentialFeatureSelector</span><span class="p">(</span><span class="n">RidgeCV</span><span class="p">(),</span> <span class="n">k_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                     <span class="n">floating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Permutation Importance (in <code class="docutils literal notranslate"><span class="pre">sklearn.inspection</span></code>), no fit-transform interface</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">importances</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> 
                                     <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">importances_mean</span>
<span class="n">feature_ids</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">importances</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="feature-engineering">
<h1>Feature Engineering<a class="headerlink" href="#feature-engineering" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Create new features based on existing ones</p>
<ul>
<li><p>Polynomial features</p></li>
<li><p>Interaction features</p></li>
<li><p>Binning</p></li>
</ul>
</li>
<li><p>Mainly useful for simple models (e.g. linear models)</p>
<ul>
<li><p>Other models can learn interations themselves</p></li>
<li><p>But may be slower, less robust than linear models</p></li>
</ul>
</li>
</ul>
<div class="section" id="polynomials">
<h2>Polynomials<a class="headerlink" href="#polynomials" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Add all polynomials up to degree <span class="math notranslate nohighlight">\(d\)</span> and all products</p>
<ul>
<li><p>Equivalent to polynomial basis expansions
$<span class="math notranslate nohighlight">\([1, x_1, ..., x_p] \xrightarrow{} [1, x_1, ..., x_p, x_1^2, ..., x_p^2, ..., x_p^d, x_1 x_2, ..., x_{p-1} x_p]\)</span>$</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>

<span class="c1"># Wavy data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">mglearn</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">make_wave</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Normal ridge</span>
<span class="n">lreg</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ridge&quot;</span><span class="p">)</span>

<span class="c1"># include polynomials up to x ** 10</span>
<span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">preg</span> <span class="o">=</span> <span class="n">Ridge</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_poly</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">line_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">preg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">line_poly</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ridge (polynomial)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Regression output&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Input feature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_84_0.png" src="../_images/06 - Data Preprocessing_84_0.png" />
</div>
</div>
</div>
<div class="section" id="binning">
<h2>Binning<a class="headerlink" href="#binning" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Partition numeric feature values into <span class="math notranslate nohighlight">\(n\)</span> intervals (bins)</p></li>
<li><p>Create <span class="math notranslate nohighlight">\(n\)</span> new one-hot features, 1 if original value falls in corresponding bin</p></li>
<li><p>Models different intervals differently (e.g. different age groups)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="c1"># create 11 equal bins</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="c1"># assign to bins</span>
<span class="n">which_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
<span class="c1"># transform using the OneHotEncoder.</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># encoder.fit finds the unique values that appear in which_bin</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">which_bin</span><span class="p">)</span>
<span class="c1"># transform creates the one-hot encoding</span>
<span class="n">X_binned</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">which_bin</span><span class="p">)</span>
<span class="c1"># Plot transformed data</span>
<span class="n">bin_names</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;[</span><span class="si">%.1f</span><span class="s1">,</span><span class="si">%.1f</span><span class="s1">]&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>
<span class="n">df_orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">])</span>
<span class="n">df_nr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">which_bin</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;which_bin&quot;</span><span class="p">])</span>
<span class="c1"># add the original features</span>
<span class="n">X_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">X_binned</span><span class="p">])</span>
<span class="n">ohedf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_combined</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">bin_names</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ohedf</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_dbd2559e_7ffa_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_dbd2559e_7ffa_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_dbd2559e_7ffa_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >orig</th>        <th class="col_heading level0 col1" >[-3.0,-1.5]</th>        <th class="col_heading level0 col2" >[-1.5,0.0]</th>        <th class="col_heading level0 col3" >[0.0,1.5]</th>        <th class="col_heading level0 col4" >[1.5,3.0]</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >-0.75</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >1.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow0_col3" class="data row0 col3" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow0_col4" class="data row0 col4" >0.00</td>
            </tr>
            <tr>
                        <th id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >2.70</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow1_col3" class="data row1 col3" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow1_col4" class="data row1 col4" >1.00</td>
            </tr>
            <tr>
                        <th id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >1.39</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >0.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow2_col3" class="data row2 col3" >1.00</td>
                        <td id="T_dbd2559e_7ffa_11eb_8532_8c8590a2facarow2_col4" class="data row2 col4" >0.00</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">line_binned</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">))</span>
<span class="n">reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_combined</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">line_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">line</span><span class="p">,</span> <span class="n">line_binned</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ridge&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">line_combined</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ridge (binned)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">bin</span><span class="p">,</span> <span class="nb">bin</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Regression output&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Input feature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_87_0.png" src="../_images/06 - Data Preprocessing_87_0.png" />
</div>
</div>
</div>
<div class="section" id="binning-interaction-features">
<h2>Binning + interaction features<a class="headerlink" href="#binning-interaction-features" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Add <em>interaction features</em> (or <em>product features</em> )</p>
<ul>
<li><p>Product of the bin encoding and the original feature value</p></li>
<li><p>Learn different weights per bin</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X_binned</span><span class="p">,</span> <span class="n">X</span> <span class="o">*</span> <span class="n">X_binned</span><span class="p">])</span>
<span class="n">bin_sname</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> 
<span class="n">X_combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">X_product</span><span class="p">])</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">bindf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_combined</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;orig&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">bin_sname</span><span class="o">+</span><span class="p">[</span><span class="s2">&quot;X*&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bin_sname</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">bindf</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_dc0bc234_7ffa_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_dc0bc234_7ffa_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_dc0bc234_7ffa_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >orig</th>        <th class="col_heading level0 col1" >b0</th>        <th class="col_heading level0 col2" >b1</th>        <th class="col_heading level0 col3" >b2</th>        <th class="col_heading level0 col4" >b3</th>        <th class="col_heading level0 col5" >X*b0</th>        <th class="col_heading level0 col6" >X*b1</th>        <th class="col_heading level0 col7" >X*b2</th>        <th class="col_heading level0 col8" >X*b3</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >-0.75</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >1.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col3" class="data row0 col3" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col4" class="data row0 col4" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col5" class="data row0 col5" >-0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col6" class="data row0 col6" >-0.75</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col7" class="data row0 col7" >-0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow0_col8" class="data row0 col8" >-0.00</td>
            </tr>
            <tr>
                        <th id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >2.70</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col3" class="data row1 col3" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col4" class="data row1 col4" >1.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col5" class="data row1 col5" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col6" class="data row1 col6" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col7" class="data row1 col7" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow1_col8" class="data row1 col8" >2.70</td>
            </tr>
            <tr>
                        <th id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >1.39</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col3" class="data row2 col3" >1.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col4" class="data row2 col4" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col5" class="data row2 col5" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col6" class="data row2 col6" >0.00</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col7" class="data row2 col7" >1.39</td>
                        <td id="T_dc0bc234_7ffa_11eb_8532_8c8590a2facarow2_col8" class="data row2 col8" >0.00</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_product</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">line_product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">line_binned</span><span class="p">,</span> <span class="n">line</span> <span class="o">*</span> <span class="n">line_binned</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">lreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ridge&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">line_product</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ridge (binned+interactions)&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="nb">bin</span><span class="p">,</span> <span class="nb">bin</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Regression output&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Input feature&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_90_0.png" src="../_images/06 - Data Preprocessing_90_0.png" />
</div>
</div>
</div>
<div class="section" id="categorical-feature-interactions">
<h2>Categorical feature interactions<a class="headerlink" href="#categorical-feature-interactions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>One-hot-encode categorical feature</p></li>
<li><p>Multiply every one-hot-encoded column with every numeric feature</p></li>
<li><p>Allows to built different submodels for different categories</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;gender&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">22</span><span class="p">],</span>
                   <span class="s1">&#39;pageviews&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">70</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">93</span><span class="p">],</span>
                   <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">269</span><span class="p">,</span> <span class="mi">1522</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">21</span><span class="p">]</span>
                  <span class="p">})</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_dc616e28_7ffa_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_dc616e28_7ffa_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_dc616e28_7ffa_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >gender</th>        <th class="col_heading level0 col1" >age</th>        <th class="col_heading level0 col2" >pageviews</th>        <th class="col_heading level0 col3" >time</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_dc616e28_7ffa_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >M</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >14</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >70</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow0_col3" class="data row0 col3" >269</td>
            </tr>
            <tr>
                        <th id="T_dc616e28_7ffa_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >F</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >16</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >12</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow1_col3" class="data row1 col3" >1522</td>
            </tr>
            <tr>
                        <th id="T_dc616e28_7ffa_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >M</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >12</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >42</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow2_col3" class="data row2 col3" >235</td>
            </tr>
            <tr>
                        <th id="T_dc616e28_7ffa_11eb_8532_8c8590a2facalevel0_row3" class="row_heading level0 row3" >3</th>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow3_col0" class="data row3 col0" >F</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow3_col1" class="data row3 col1" >25</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow3_col2" class="data row3 col2" >64</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow3_col3" class="data row3 col3" >63</td>
            </tr>
            <tr>
                        <th id="T_dc616e28_7ffa_11eb_8532_8c8590a2facalevel0_row4" class="row_heading level0 row4" >4</th>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow4_col0" class="data row4 col0" >F</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow4_col1" class="data row4 col1" >22</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow4_col2" class="data row4 col2" >93</td>
                        <td id="T_dc616e28_7ffa_11eb_8532_8c8590a2facarow4_col3" class="data row4 col3" >21</td>
            </tr>
    </tbody></table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df_f</span> <span class="o">=</span> <span class="n">dummies</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dummies</span><span class="o">.</span><span class="n">gender_F</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;rows&#39;</span><span class="p">)</span>
<span class="n">df_f</span> <span class="o">=</span> <span class="n">df_f</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_F&quot;</span><span class="p">)</span>
<span class="n">df_m</span> <span class="o">=</span> <span class="n">dummies</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">dummies</span><span class="o">.</span><span class="n">gender_M</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;rows&#39;</span><span class="p">)</span>
<span class="n">df_m</span> <span class="o">=</span> <span class="n">df_m</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">&quot;_M&quot;</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_m</span><span class="p">,</span> <span class="n">df_f</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;gender_F_M&quot;</span><span class="p">,</span> <span class="s2">&quot;gender_M_F&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style  type="text/css" >
    #T_dc66175c_7ffa_11eb_8532_8c8590a2faca th {
          font-size: 30px;
    }    #T_dc66175c_7ffa_11eb_8532_8c8590a2faca td {
          font-size: 30px;
    }</style><table id="T_dc66175c_7ffa_11eb_8532_8c8590a2faca" ><thead>    <tr>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >age_M</th>        <th class="col_heading level0 col1" >pageviews_M</th>        <th class="col_heading level0 col2" >time_M</th>        <th class="col_heading level0 col3" >gender_M_M</th>        <th class="col_heading level0 col4" >age_F</th>        <th class="col_heading level0 col5" >pageviews_F</th>        <th class="col_heading level0 col6" >time_F</th>        <th class="col_heading level0 col7" >gender_F_F</th>    </tr></thead><tbody>
                <tr>
                        <th id="T_dc66175c_7ffa_11eb_8532_8c8590a2facalevel0_row0" class="row_heading level0 row0" >0</th>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col0" class="data row0 col0" >14</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col1" class="data row0 col1" >70</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col2" class="data row0 col2" >269</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col3" class="data row0 col3" >1</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col4" class="data row0 col4" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col5" class="data row0 col5" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col6" class="data row0 col6" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow0_col7" class="data row0 col7" >0</td>
            </tr>
            <tr>
                        <th id="T_dc66175c_7ffa_11eb_8532_8c8590a2facalevel0_row1" class="row_heading level0 row1" >1</th>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col0" class="data row1 col0" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col1" class="data row1 col1" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col2" class="data row1 col2" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col3" class="data row1 col3" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col4" class="data row1 col4" >16</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col5" class="data row1 col5" >12</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col6" class="data row1 col6" >1522</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow1_col7" class="data row1 col7" >1</td>
            </tr>
            <tr>
                        <th id="T_dc66175c_7ffa_11eb_8532_8c8590a2facalevel0_row2" class="row_heading level0 row2" >2</th>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col0" class="data row2 col0" >12</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col1" class="data row2 col1" >42</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col2" class="data row2 col2" >235</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col3" class="data row2 col3" >1</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col4" class="data row2 col4" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col5" class="data row2 col5" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col6" class="data row2 col6" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow2_col7" class="data row2 col7" >0</td>
            </tr>
            <tr>
                        <th id="T_dc66175c_7ffa_11eb_8532_8c8590a2facalevel0_row3" class="row_heading level0 row3" >3</th>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col0" class="data row3 col0" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col1" class="data row3 col1" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col2" class="data row3 col2" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col3" class="data row3 col3" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col4" class="data row3 col4" >25</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col5" class="data row3 col5" >64</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col6" class="data row3 col6" >63</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow3_col7" class="data row3 col7" >1</td>
            </tr>
            <tr>
                        <th id="T_dc66175c_7ffa_11eb_8532_8c8590a2facalevel0_row4" class="row_heading level0 row4" >4</th>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col0" class="data row4 col0" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col1" class="data row4 col1" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col2" class="data row4 col2" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col3" class="data row4 col3" >0</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col4" class="data row4 col4" >22</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col5" class="data row4 col5" >93</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col6" class="data row4 col6" >21</td>
                        <td id="T_dc66175c_7ffa_11eb_8532_8c8590a2facarow4_col7" class="data row4 col7" >1</td>
            </tr>
    </tbody></table></div></div>
</div>
</div>
</div>
<div class="section" id="missing-value-imputation">
<h1>Missing value imputation<a class="headerlink" href="#missing-value-imputation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Data can be missing in different ways:</p>
<ul>
<li><p>Missing Completely at Random (MCAR): purely random points are missing</p></li>
<li><p>Missing at Random (MAR): something affects missingness, but no relation with the value</p>
<ul>
<li><p>E.g. faulty sensors, some people don’t fill out forms correctly</p></li>
</ul>
</li>
<li><p>Missing Not At Random (MNAR): systematic missingness linked to the value</p>
<ul>
<li><p>Has to be modelled or resolved (e.g. sensor decay, sick people leaving study)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Missingness can be encoded in different ways:’?’, ‘-1’, ‘unknown’, ‘NA’,…</p></li>
<li><p>Also labels can be missing (remove example or use semi-supervised learning)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span><span class="p">,</span> <span class="n">KNNImputer</span><span class="p">,</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">BayesianRidge</span>
<span class="kn">from</span> <span class="nn">fancyimpute</span> <span class="kn">import</span> <span class="n">SoftImpute</span><span class="p">,</span> <span class="n">IterativeSVD</span><span class="p">,</span> <span class="n">MatrixFactorization</span>

<span class="kn">from</span> <span class="nn">sklearn.utils._testing</span> <span class="kn">import</span> <span class="n">ignore_warnings</span>
<span class="kn">from</span> <span class="nn">sklearn.exceptions</span> <span class="kn">import</span> <span class="n">ConvergenceWarning</span>

<span class="c1"># Colors</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">norm</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">colors</span>

<span class="c1"># Iris dataset with some added noise and missing values</span>
<span class="k">def</span> <span class="nf">missing_iris</span><span class="p">():</span>
    <span class="n">iris</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span>
    
    <span class="c1"># Make some noise</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span>
    
    <span class="c1"># Add missing data. Set smallest leaf measurements to NaN</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.6</span>
    <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">6.5</span>
    <span class="n">X</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="c1"># List of my favorite imputers</span>
<span class="n">imputers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Mean Imputation&quot;</span><span class="p">:</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span> 
            <span class="s2">&quot;kNN Imputation&quot;</span><span class="p">:</span> <span class="n">KNNImputer</span><span class="p">(),</span> 
            <span class="s2">&quot;Iterative Imputation (RandomForest)&quot;</span><span class="p">:</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">()),</span>
            <span class="s2">&quot;Iterative Imputation (BayesianRidge)&quot;</span><span class="p">:</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">BayesianRidge</span><span class="p">()),</span>
            <span class="s2">&quot;SoftImpute&quot;</span><span class="p">:</span> <span class="n">SoftImpute</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;Matrix Factorization&quot;</span><span class="p">:</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
           <span class="p">}</span>

<span class="nd">@ignore_warnings</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">ConvergenceWarning</span><span class="p">)</span>
<span class="nd">@ignore_warnings</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">plot_imputation</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">missing_iris</span><span class="p">()</span>
    <span class="n">imputed_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">X_imp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">imputers</span><span class="p">[</span><span class="n">imputer</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">KNNImputer</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">IterativeImputer</span><span class="p">):</span>
        <span class="n">X_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">imp_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(),</span> <span class="n">imp</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">imp_pipe</span><span class="p">,</span> <span class="n">X_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">X_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (ACC:</span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imputer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_imp</span><span class="p">[</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">X_imp</span><span class="p">[</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">imputed_mask</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;brg&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_imp</span><span class="p">[</span><span class="o">~</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">X_imp</span><span class="p">[</span><span class="o">~</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">imputed_mask</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;brg&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">)</span>
    <span class="c1"># this is for creating the legend...</span>
    <span class="n">square</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Imputed data&#39;</span><span class="p">)</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">square</span><span class="p">,</span> <span class="n">circle</span><span class="p">],</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Mean/constant imputation</p></li>
<li><p>kNN-based imputation</p></li>
<li><p>Iterative (model-based) imputation</p></li>
<li><p>Matrix Factorization techniques</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">compare_imputers</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bcfc18fc9b2942d58f7f077d7e492836", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;kNN Imputation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="mean-imputation">
<h2>Mean imputation<a class="headerlink" href="#mean-imputation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Replace all missing values of a feature by the same value</p>
<ul>
<li><p>Numerical features: mean or median</p></li>
<li><p>Categorical features: most frequent category</p></li>
<li><p>Constant value, e.g. 0 or ‘missing’ for text features</p></li>
</ul>
</li>
<li><p>Optional: add an indicator column for missingness</p></li>
<li><p>Example: Iris dataset (randomly removed values in 3rd and 4th column)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Mean Imputation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_100_0.png" src="../_images/06 - Data Preprocessing_100_0.png" />
</div>
</div>
</div>
<div class="section" id="knn-imputation">
<h2>kNN imputation<a class="headerlink" href="#knn-imputation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Use special version of kNN to predict value of missing points</p></li>
<li><p>Uses only non-missing data when computing distances</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;kNN Imputation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_102_0.png" src="../_images/06 - Data Preprocessing_102_0.png" />
</div>
</div>
</div>
<div class="section" id="iterative-model-based-imputation">
<h2>Iterative (model-based) Imputation<a class="headerlink" href="#iterative-model-based-imputation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Better known as Multiple Imputation by Chained Equations (MICE)</p></li>
<li><p>Iterative approach</p>
<ul>
<li><p>Do first imputation (e.g. mean imputation)</p></li>
<li><p>Train model (e.g. RandomForest) to predict missing values of a given feature</p></li>
<li><p>Train new model on imputed data to predict missing values of the next feature</p>
<ul>
<li><p>Repeat <span class="math notranslate nohighlight">\(m\)</span> times in round-robin fashion, leave one feature out at a time</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Iterative Imputation (RandomForest)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_104_0.png" src="../_images/06 - Data Preprocessing_104_0.png" />
</div>
</div>
</div>
<div class="section" id="matrix-factorization">
<h2>Matrix Factorization<a class="headerlink" href="#matrix-factorization" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Basic idea: low-rank approximation</p>
<ul>
<li><p>Replace missing values by 0</p></li>
<li><p>Factorize <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> with rank <span class="math notranslate nohighlight">\(r\)</span>: <span class="math notranslate nohighlight">\(\mathbf{X}^{n\times p}=\mathbf{U}^{n\times r} \mathbf{V}^{r\times p}\)</span></p>
<ul>
<li><p>With n data points and p features</p></li>
<li><p>Solved using gradient descent</p></li>
</ul>
</li>
<li><p>Recompute <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>: now complete</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Matrix Factorization&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_106_0.png" src="../_images/06 - Data Preprocessing_106_0.png" />
</div>
</div>
</div>
<div class="section" id="soft-thresholded-singular-value-decomposition-svd">
<h2>Soft-thresholded Singular Value Decomposition (SVD)<a class="headerlink" href="#soft-thresholded-singular-value-decomposition-svd" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Same basic idea, but smoother</p>
<ul>
<li><p>Replace missing values by 0, compute SVD: <span class="math notranslate nohighlight">\(\mathbf{X}=\mathbf{U} \mathbf{\Sigma} \mathbf{V^{T}}\)</span></p>
<ul>
<li><p>Solved with gradient descent</p></li>
</ul>
</li>
<li><p>Reduce eigenvalues by shrinkage factor: <span class="math notranslate nohighlight">\(\lambda_i = s\cdot\lambda_i\)</span></p></li>
<li><p>Recompute <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>: now complete</p></li>
<li><p>Repeat for <span class="math notranslate nohighlight">\(m\)</span> iterations</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;SoftImpute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_108_0.png" src="../_images/06 - Data Preprocessing_108_0.png" />
</div>
</div>
</div>
<div class="section" id="id6">
<h2>Comparison<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Best method depends on the problem and dataset at hand. Use cross-validation.</p></li>
<li><p>Iterative Imputation (MICE) generally works well for missing (completely) at random data</p>
<ul>
<li><p>Can be slow if the prediction model is slow</p></li>
</ul>
</li>
<li><p>Low-rank approximation techniques scale well to large datasets</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">compare_imputers</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fe03ce223aa741e2a3a6e3f56e83e62f", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Iterative Imputation (RandomForest)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id7">
<h2>In practice (scikit-learn)<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Simple replacement: <code class="docutils literal notranslate"><span class="pre">SimpleImputer</span></code></p>
<ul>
<li><p>Strategies: <code class="docutils literal notranslate"><span class="pre">mean</span></code> (numeric), <code class="docutils literal notranslate"><span class="pre">median</span></code>, <code class="docutils literal notranslate"><span class="pre">most_frequent</span></code> (categorical)</p></li>
<li><p>Choose whether to add indicator columns, and how missing values are encoded</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">missing_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">add_indicator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>kNN Imputation: <code class="docutils literal notranslate"><span class="pre">KNNImputer</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">KNNImputer</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Multiple Imputation (MICE): <code class="docutils literal notranslate"><span class="pre">IterativeImputer</span></code></p>
<ul>
<li><p>Choose estimator (default: <code class="docutils literal notranslate"><span class="pre">BayesianRidge</span></code>) and number of iterations (default 10)</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">RandomForestClassifier</span><span class="p">(),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="in-practice-fancyimpute">
<h2>In practice (fancyimpute)<a class="headerlink" href="#in-practice-fancyimpute" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Cannot be used in CV pipelines (has <code class="docutils literal notranslate"><span class="pre">fit_transform</span></code> but no <code class="docutils literal notranslate"><span class="pre">transform</span></code>)</p></li>
<li><p>Soft-Thresholded SVD: <code class="docutils literal notranslate"><span class="pre">SoftImpute</span></code></p>
<ul>
<li><p>Choose max number of gradient descent iterations</p></li>
<li><p>Choose shrinkage value for eigenvectors (default: <span class="math notranslate nohighlight">\(\frac{1}{N}\)</span>)</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SoftImpute</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shrinkage_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Low-rank imputation: <code class="docutils literal notranslate"><span class="pre">MatrixFactorization</span></code></p>
<ul>
<li><p>Choose rank of the low-rank approximation</p></li>
<li><p>Gradient descent hyperparameters: learning rate, epochs,…</p></li>
<li><p>Several variants exist</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="handling-imbalanced-data">
<h1>Handling imbalanced data<a class="headerlink" href="#handling-imbalanced-data" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Problem:</p>
<ul>
<li><p>You have a majority class with many times the number of examples as the minority class</p></li>
<li><p>Or: classes are balanced, but associated costs are not (e.g. FN are worse than FP)</p></li>
</ul>
</li>
<li><p>We already covered some ways to resolve this:</p>
<ul>
<li><p>Add class weights to the loss function: give the minority class more weight</p>
<ul>
<li><p>In practice: set <code class="docutils literal notranslate"><span class="pre">class_weight='balanced'</span></code></p></li>
</ul>
</li>
<li><p>Change the prediction threshold to minimize false negatives or false positives</p></li>
</ul>
</li>
<li><p>There are also things we can do by preprocessing the data</p>
<ul>
<li><p>Resample the data to correct the imbalance</p>
<ul>
<li><p>Random or model-based</p></li>
</ul>
</li>
<li><p>Generate synthetic samples for the minority class</p></li>
<li><p>Build ensembles over different resampled datasets</p></li>
<li><p>Combinations of these</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">imblearn.over_sampling</span> <span class="kn">import</span> <span class="n">RandomOverSampler</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">,</span> <span class="n">ADASYN</span>
<span class="kn">from</span> <span class="nn">imblearn.under_sampling</span> <span class="kn">import</span> <span class="n">RandomUnderSampler</span><span class="p">,</span> <span class="n">EditedNearestNeighbours</span><span class="p">,</span> <span class="n">CondensedNearestNeighbour</span>
<span class="kn">from</span> <span class="nn">imblearn.ensemble</span> <span class="kn">import</span> <span class="n">EasyEnsembleClassifier</span><span class="p">,</span> <span class="n">BalancedBaggingClassifier</span>
<span class="kn">from</span> <span class="nn">imblearn.combine</span> <span class="kn">import</span> <span class="n">SMOTEENN</span>
<span class="kn">from</span> <span class="nn">imblearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span> <span class="k">as</span> <span class="n">make_imb_pipeline</span> <span class="c1"># avoid confusion</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_validate</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="c1"># Some imbalanced data</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">n_samples_1</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">n_samples_2</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">X_syn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="n">y_syn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_samples_1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_samples_2</span><span class="p">))</span>
<span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
<span class="n">X_syn_train</span><span class="p">,</span> <span class="n">X_syn_test</span><span class="p">,</span> <span class="n">y_syn_train</span><span class="p">,</span> <span class="n">y_syn_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
<span class="n">X0min</span><span class="p">,</span> <span class="n">X0max</span><span class="p">,</span> <span class="n">X1min</span><span class="p">,</span> <span class="n">X1max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">samplers</span> <span class="o">=</span> <span class="p">[</span><span class="n">RandomUnderSampler</span><span class="p">(),</span><span class="n">EditedNearestNeighbours</span><span class="p">(),</span><span class="n">CondensedNearestNeighbour</span><span class="p">(),</span><span class="n">RandomOverSampler</span><span class="p">(),</span>
           <span class="n">SMOTE</span><span class="p">(),</span> <span class="n">ADASYN</span><span class="p">(),</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(),</span> <span class="n">BalancedBaggingClassifier</span><span class="p">(),</span> <span class="n">SMOTEENN</span><span class="p">()]</span>
<span class="n">learners</span> <span class="o">=</span> <span class="p">[</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">(),</span> <span class="n">RandomForestClassifier</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">plot_imbalance</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="n">RandomUnderSampler</span><span class="p">(),</span> <span class="n">sampler2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">()):</span>
    
    <span class="c1"># Appends multiple undersamplings for plotting purposes</span>
    <span class="k">def</span> <span class="nf">simulate_bagging</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">):</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">X_resampled_i</span><span class="p">,</span> <span class="n">y_resampled_i</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
            <span class="n">X_resampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">,</span><span class="n">X_resampled_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">,</span><span class="n">y_resampled_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span>
    
    <span class="k">def</span> <span class="nf">build_evaluate</span><span class="p">(</span><span class="n">sampler</span><span class="p">):</span>
        <span class="c1"># Build new data</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">EasyEnsembleClassifier</span><span class="p">):</span>
            <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">simulate_bagging</span><span class="p">(</span><span class="n">RandomUnderSampler</span><span class="p">(),</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">BalancedBaggingClassifier</span><span class="p">):</span>
            <span class="n">balancer</span> <span class="o">=</span> <span class="n">RandomUnderSampler</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">simulate_bagging</span><span class="p">(</span><span class="n">balancer</span><span class="p">,</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>

        <span class="c1"># Evaluate</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">EasyEnsembleClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(</span><span class="n">base_estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">BalancedBaggingClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">BalancedBaggingClassifier</span><span class="p">(</span><span class="n">base_estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">)[</span><span class="s1">&#39;test_score&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scores</span>
    
    <span class="n">orig_scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">)[</span><span class="s1">&#39;test_score&#39;</span><span class="p">]</span>
        
    <span class="c1"># Plot</span>
    <span class="n">nr_plots</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">sampler2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">3</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">nr_plots</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xticks&#39;</span><span class="p">:(),</span> <span class="s1">&#39;yticks&#39;</span><span class="p">:()})</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original (AUC: </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">orig_scores</span><span class="p">)))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_syn</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">y_syn</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
 
    <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">build_evaluate</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (AUC: </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)));</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">X0min</span><span class="p">,</span> <span class="n">X0max</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">X1min</span><span class="p">,</span> <span class="n">X1max</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">sampler2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">build_evaluate</span><span class="p">(</span><span class="n">sampler2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (AUC: </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sampler2</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)));</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">X0min</span><span class="p">,</span> <span class="n">X0max</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">X1min</span><span class="p">,</span> <span class="n">X1max</span><span class="p">))</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="random-undersampling">
<h2>Random Undersampling<a class="headerlink" href="#random-undersampling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Copy the points from the minority class</p></li>
<li><p>Randomly sample from the majority class (with or without replacement) until balanced</p>
<ul>
<li><p>Optionally, sample until a certain imbalance ratio (e.g. 1/5) is reached</p></li>
<li><p>Multi-class: repeat with every other class</p></li>
</ul>
</li>
<li><p>Preferred for large datasets, often yields smaller/faster models with similar performance</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">RandomUnderSampler</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_117_0.png" src="../_images/06 - Data Preprocessing_117_0.png" />
</div>
</div>
</div>
<div class="section" id="model-based-undersampling">
<h2>Model-based Undersampling<a class="headerlink" href="#model-based-undersampling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Edited Nearest Neighbors</p>
<ul>
<li><p>Remove all majority samples that are misclassified by kNN (mode) or that have a neighbor from the other class (all).</p></li>
<li><p>Remove their influence on the minority samples</p></li>
</ul>
</li>
<li><p>Condensed Nearest Neighbors</p>
<ul>
<li><p>Remove all majority samples that are <em>not</em> misclassified by kNN</p></li>
<li><p>Focus on only the hard samples</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">EditedNearestNeighbours</span><span class="p">(),</span> <span class="n">CondensedNearestNeighbour</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_119_0.png" src="../_images/06 - Data Preprocessing_119_0.png" />
</div>
</div>
</div>
<div class="section" id="random-oversampling">
<h2>Random Oversampling<a class="headerlink" href="#random-oversampling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Copy the points from the majority class</p></li>
<li><p>Randomly sample from the minority class, with replacement, until balanced</p>
<ul>
<li><p>Optionally, sample until a certain imbalance ratio (e.g. 1/5) is reached</p></li>
</ul>
</li>
<li><p>Makes models more expensive to train, doens’t always improve performance</p></li>
<li><p>Similar to giving minority class(es) a higher weight (and more expensive)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">RandomOverSampler</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_121_0.png" src="../_images/06 - Data Preprocessing_121_0.png" />
</div>
</div>
</div>
<div class="section" id="synthetic-minority-oversampling-technique-smote">
<h2>Synthetic Minority Oversampling Technique (SMOTE)<a class="headerlink" href="#synthetic-minority-oversampling-technique-smote" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Repeatedly choose a random minority point and a neighboring minority point</p>
<ul>
<li><p>Pick a new, artificial point on the line between them (uniformly)</p></li>
</ul>
</li>
<li><p>May bias the data. Be careful never to create artificial points in the test set.</p></li>
<li><p>ADASYN (Adaptive Synthetic)</p>
<ul>
<li><p>Similar, but starts from ‘hard’ minority points (misclassified by kNN)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">SMOTE</span><span class="p">(),</span> <span class="n">ADASYN</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_123_0.png" src="../_images/06 - Data Preprocessing_123_0.png" />
</div>
</div>
</div>
<div class="section" id="combined-techniques">
<h2>Combined techniques<a class="headerlink" href="#combined-techniques" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Combines over- and under-sampling</p></li>
<li><p>E.g. oversampling with SMOTE, undersampling with Edited Nearest Neighbors (ENN)</p>
<ul>
<li><p>SMOTE can generate ‘noisy’ point, close to majority class points</p></li>
<li><p>ENN will remove up these majority points to ‘clean up’ the space</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">SMOTEENN</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_125_0.png" src="../_images/06 - Data Preprocessing_125_0.png" />
</div>
</div>
</div>
<div class="section" id="ensemble-resampling">
<h2>Ensemble Resampling<a class="headerlink" href="#ensemble-resampling" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Bagged ensemble of balanced base learners. Acts as a learner, not a preprocessor</p></li>
<li><p>BalancedBagging: take bootstraps, randomly undersample each, train models (e.g. trees)</p>
<ul>
<li><p>Benefits of random undersampling without throwing out so much data</p></li>
</ul>
</li>
<li><p>Easy Ensemble: take multiple random undersamplings directly, train models</p>
<ul>
<li><p>Traditionally uses AdaBoost as base learner, but can be replaced</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">EasyEnsembleClassifier</span><span class="p">(),</span> <span class="n">BalancedBaggingClassifier</span><span class="p">())</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/06 - Data Preprocessing_127_0.png" src="../_images/06 - Data Preprocessing_127_0.png" />
</div>
</div>
</div>
<div class="section" id="id8">
<h2>Comparison<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The best method depends on the data (amount of data, imbalance,…)</p>
<ul>
<li><p>For a very large dataset, random undersampling may be fine</p></li>
</ul>
</li>
<li><p>You still need to choose the appropriate learning algorithms</p></li>
<li><p>Don’t forget about class weighting and prediction thresholding</p>
<ul>
<li><p>Some combinations are useful, e.g. SMOTE + class weighting + thresholding</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">compare_imbalance</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="n">samplers</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="n">learners</span><span class="p">):</span>
    <span class="n">plot_imbalance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f834daa321e240dd8efc906bb338480b", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_imbalance</span><span class="p">(</span><span class="n">EasyEnsembleClassifier</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="in-practice-imblearn">
<h2>In practice (<a class="reference external" href="http://imbalanced-learn.org">imblearn</a>)<a class="headerlink" href="#in-practice-imblearn" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Follows fit-sample paradigm (equivalent of fit-transform, but also affects y)</p></li>
<li><p>Undersampling: RandomUnderSampler, EditedNearestNeighbours,…</p></li>
<li><p>(Synthetic) Oversampling: RandomOverSampler, SMOTE, ADASYN,…</p></li>
<li><p>Combinations: SMOTEENN,…</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">k_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Can be used in imblearn pipelines (not sklearn pipelines)</p>
<ul>
<li><p>imblearn pipelines are compatible with GridSearchCV,…</p></li>
<li><p>Sampling is only done in <code class="docutils literal notranslate"><span class="pre">fit</span></code> (not in <code class="docutils literal notranslate"><span class="pre">predict</span></code>)</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smote_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SMOTE</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">smote_pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k_neighbors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]}</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">smote_pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The ensembling techniques should be used as wrappers</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">clf</span> <span class="o">=</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(</span><span class="n">base_estimator</span><span class="o">=</span><span class="n">SVC</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="real-world-data">
<h2>Real-world data<a class="headerlink" href="#real-world-data" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The effect of sampling procedures can be unpredictable</p></li>
<li><p>Best method can depend on the data and FP/FN trade-offs</p></li>
<li><p>SMOTE and ensembling techniques often work well</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">precision_recall_curve</span>

<span class="c1"># Datasets</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Speech&#39;</span><span class="p">,</span><span class="s1">&#39;mc1&#39;</span><span class="p">,</span><span class="s1">&#39;mammography&#39;</span><span class="p">]</span>
    
<span class="n">roc_curves</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Get data</span>
    <span class="n">data_imb</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">X_imb</span><span class="p">,</span> <span class="n">y_imb</span> <span class="o">=</span> <span class="n">data_imb</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data_imb</span><span class="o">.</span><span class="n">target</span>
    <span class="n">y_imb</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_imb</span><span class="p">)</span>
    <span class="n">X_imb_train</span><span class="p">,</span> <span class="n">X_imb_test</span><span class="p">,</span> <span class="n">y_imb_train</span><span class="p">,</span> <span class="n">y_imb_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_imb</span><span class="p">,</span> <span class="n">y_imb</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_imb</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Original data</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_imb_train</span><span class="p">,</span> <span class="n">y_imb_train</span><span class="p">)</span>
    <span class="n">probs_original</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_imb_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr_org</span><span class="p">,</span> <span class="n">tpr_org</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs_original</span><span class="p">)</span>
    <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs_original</span><span class="p">)</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;fpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr_org</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;tpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpr_org</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall</span>

    <span class="c1"># Corrected data</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sampler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samplers</span><span class="p">):</span>
        <span class="n">sname</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluating&quot;</span><span class="p">,</span> <span class="n">sname</span><span class="p">)</span>
        <span class="c1"># Evaluate</span>
        <span class="n">learner</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">EasyEnsembleClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(</span><span class="n">base_estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">BalancedBaggingClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">BalancedBaggingClassifier</span><span class="p">(</span><span class="n">base_estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span>

        <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_imb_train</span><span class="p">,</span> <span class="n">y_imb_train</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_imb_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;fpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;tpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpr</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset Speech
Evaluating RandomUnderSampler
Evaluating EditedNearestNeighbours
Evaluating CondensedNearestNeighbour
Evaluating RandomOverSampler
Evaluating SMOTE
Evaluating ADASYN
Evaluating EasyEnsembleClassifier
Evaluating BalancedBaggingClassifier
Evaluating SMOTEENN
Dataset mc1
Evaluating RandomUnderSampler
Evaluating EditedNearestNeighbours
Evaluating CondensedNearestNeighbour
Evaluating RandomOverSampler
Evaluating SMOTE
Evaluating ADASYN
Evaluating EasyEnsembleClassifier
Evaluating BalancedBaggingClassifier
Evaluating SMOTEENN
Dataset mammography
Evaluating RandomUnderSampler
Evaluating EditedNearestNeighbours
Evaluating CondensedNearestNeighbour
Evaluating RandomOverSampler
Evaluating SMOTE
Evaluating ADASYN
Evaluating EasyEnsembleClassifier
Evaluating BalancedBaggingClassifier
Evaluating SMOTEENN
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Colors for 9 methods</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hsv&#39;</span><span class="p">)</span>
<span class="n">roccol</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">roccol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="mi">9</span><span class="p">))</span>
    
<span class="n">curves</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ROC&#39;</span><span class="p">,</span><span class="s1">&#39;Precision-Recall&#39;</span><span class="p">]</span>

<span class="nd">@interact</span>
<span class="k">def</span> <span class="nf">roc_imbalance</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">curves</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># Add to plot</span>
    <span class="n">curvy</span> <span class="o">=</span> <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">curve</span> <span class="o">==</span> <span class="s1">&#39;ROC&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;fpr&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;tpr&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
            <span class="n">curvy</span> <span class="o">=</span> <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">method</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">curve</span> <span class="o">==</span> <span class="s1">&#39;ROC&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;fpr&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;tpr&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">roccol</span><span class="p">[</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">roccol</span><span class="p">[</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">curve</span> <span class="o">==</span> <span class="s1">&#39;ROC&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RandomForest ROC curve on </span><span class="si">{}</span><span class="s2"> dataset&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Recall&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Precision&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RandomForest PR curve on </span><span class="si">{}</span><span class="s2"> dataset&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d183808fc6b242849e0d7e1a44ebcd7b", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">roc_imbalance</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;Speech&#39;</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="s1">&#39;ROC&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="summary">
<h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Data preprocessing is a crucial part of machine learning</p>
<ul>
<li><p>Scaling is important for many distance-based methods (e.g. kNN, SVM, Neural Nets)</p></li>
<li><p>Categorical encoding is necessary for numeric methods (or implementations)</p></li>
<li><p>Selecting features can speed up models and reduce overfitting</p></li>
<li><p>Feature engineering is often useful for linear models</p></li>
<li><p>It is often better to impute missing data than to remove data</p></li>
<li><p>Imbalanced datasets require extra care to build useful models</p></li>
</ul>
</li>
<li><p>Pipelines allow us to encapsulate multiple steps in a convenient way</p>
<ul>
<li><p>Avoids data leakage, crucial for proper evaluation</p></li>
</ul>
</li>
<li><p>Choose the right preprocessing steps and models in your pipeline</p>
<ul>
<li><p>Cross-validation helps, but the search space is huge</p></li>
<li><p>Smarter techniques exist to automate this process (AutoML)</p></li>
</ul>
</li>
</ul>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Joaquin Vanschoren<br/>
    
        &copy; Copyright 2021.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>